<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of makeConsIm</title>
  <meta name="keywords" content="makeConsIm">
  <meta name="description" content="makeConsIm Computes consensus fluorescence localization from cells in a cell files">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerOpti_Release</a> &gt; <a href="index.html">viz</a> &gt; makeConsIm.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerOpti_Release/viz&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>makeConsIm
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>makeConsIm Computes consensus fluorescence localization from cells in a cell files</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [ imMosaic, imColor, imBW, imInv, kymo, kymoMask, I,kymoMax, kymoMaskMax, imMosaic10, imBWunmasked, imBWmask, hotPix,AA, BB ] = makeConsIm( dirName, CONST, skip, mag, disp_flag ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> makeConsIm Computes consensus fluorescence localization from cells in a cell files

 INPUT:
   dirName : (string) directory to load cell files from
     CONST : (struct) Constants to use in calculation
      skip : (integer) Use every skip images to make cons image
       mag : (double) resize images by factor mag to generate cons image
 disp_flag : (flag) flag to show cells while they are processed

 OUPUT:
  imMosaic : Image mosaic of cells that make up the consensus image
   imColor : Color cons image (w/ black background)
      imBW : Grayscale cons image
     imInv : Color cons image (w/ white background)
      kymo : Consensus Kymograph
  kymoMask : Consensus Kymograph Cell mask
         I : Fit of intensities to a model for polar localization

 Copyright (C) 2016 Wiggins Lab
 University of Washington, 2016
 This file is part of SuperSeggerOpti.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="colorize.html" class="code" title="function  imTmp_ = colorize( im, mask, colormap_, back )">colorize</a>	</li><li><a href="doColorMap.html" class="code" title="function im_ = doColorMap( im, colormap_ )">doColorMap</a>	</li><li><a href="fitKymo4.html" class="code" title="function [ I ] = fitKymo4( kymo, kymoMask, disp_flag )">fitKymo4</a>	UNTITLED Summary of this function goes here</li><li><a href="makeTowerCons.html" class="code" title="function  imData = makeTowerCons( data, CONST, xdim,disp_flag, skip, mag )">makeTowerCons</a>	makeTowerCons Makes Times-Lapse Tower with normalized time and cell shape</li><li><a href="pcanal4.html" class="code" title="function [A,B,imArray] = pcanal(dataCellArray,disp_flag)">pcanal4</a>	Copyright (C) 2016 Wiggins Lab</li><li><a href="towerMergeImages.html" class="code" title="function [imColor, imBW, towerIm, maskCons, nx, ny, max_x, max_y ] =towerMergeImages( imCell, maskCell, ssCell, xdim, skip, mag, CONST )">towerMergeImages</a>	towerMergeImages</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="trackOptiView.html" class="code" title="function trackOptiView(dirname,file_filter,err_flag)">trackOptiView</a>	trackOptiView provides visulization of the segmented data.</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [ imMosaic, imColor, imBW, imInv, imMosaic10] =</a></li><li><a href="#_sub2" class="code">function [ kymo,kymoMask,kymoMax, kymoMaskMax ] =</a></li><li><a href="#_sub3" class="code">function dataArray = intUpdate( dataArray, data, jj )</a></li><li><a href="#_sub4" class="code">function dataArray = intNormalize( dataArray, numCells )</a></li><li><a href="#_sub5" class="code">function data = intInit( numCells )</a></li><li><a href="#_sub6" class="code">function [ data, num_filename ] = intLoader( dirName, filename )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [ imMosaic, imColor, imBW, imInv, kymo, kymoMask, I,</a><span class="keyword">...</span>
0002     kymoMax, kymoMaskMax, imMosaic10, imBWunmasked, imBWmask, hotPix, <span class="keyword">...</span>
0003     AA, BB ] = makeConsIm( dirName, CONST, skip, mag, disp_flag )
0004 <span class="comment">% makeConsIm Computes consensus fluorescence localization from cells in a cell files</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% INPUT:</span>
0007 <span class="comment">%   dirName : (string) directory to load cell files from</span>
0008 <span class="comment">%     CONST : (struct) Constants to use in calculation</span>
0009 <span class="comment">%      skip : (integer) Use every skip images to make cons image</span>
0010 <span class="comment">%       mag : (double) resize images by factor mag to generate cons image</span>
0011 <span class="comment">% disp_flag : (flag) flag to show cells while they are processed</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% OUPUT:</span>
0014 <span class="comment">%  imMosaic : Image mosaic of cells that make up the consensus image</span>
0015 <span class="comment">%   imColor : Color cons image (w/ black background)</span>
0016 <span class="comment">%      imBW : Grayscale cons image</span>
0017 <span class="comment">%     imInv : Color cons image (w/ white background)</span>
0018 <span class="comment">%      kymo : Consensus Kymograph</span>
0019 <span class="comment">%  kymoMask : Consensus Kymograph Cell mask</span>
0020 <span class="comment">%         I : Fit of intensities to a model for polar localization</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% Copyright (C) 2016 Wiggins Lab</span>
0023 <span class="comment">% University of Washington, 2016</span>
0024 <span class="comment">% This file is part of SuperSeggerOpti.</span>
0025 
0026 
0027 del = 0.0;
0028 imMosaic10 = [];
0029 <span class="comment">%disp_flag = 1;</span>
0030 
0031 <span class="keyword">if</span> ~exist( <span class="string">'skip'</span>, <span class="string">'var'</span> ) || isempty( skip )
0032     skip = 1;
0033 <span class="keyword">end</span>
0034 
0035 <span class="keyword">if</span> ~exist( <span class="string">'mag'</span>, <span class="string">'var'</span> ) || isempty( mag )
0036     mag = 4;
0037 <span class="keyword">end</span>
0038 
0039 
0040 <span class="comment">% show images in false color</span>
0041 <span class="keyword">if</span> ~isfield(CONST.view, <span class="string">'falseColorFlag'</span> )
0042     CONST.view.falseColorFlag = false;
0043 <span class="keyword">end</span>
0044 
0045 
0046 
0047 
0048 <span class="comment">% Get the number of cells in the cell directory</span>
0049 <span class="keyword">if</span> ~isfield( CONST, <span class="string">'view'</span>) || CONST.view.showFullCellCycleOnly
0050     contents = dir([dirName,filesep,<span class="string">'Cell*.mat'</span>]);
0051 <span class="keyword">else</span>
0052     contents = dir([dirName,filesep,<span class="string">'*ell*.mat'</span>]);
0053 <span class="keyword">end</span>
0054 numCells = numel(contents);
0055 
0056 
0057 <span class="comment">% put in a max cell number to stop the code stalling</span>
0058 <span class="keyword">if</span> ~isfield(CONST.view, <span class="string">'maxNumCell'</span> )
0059     CONST.view.maxNumCell = [];
0060 <span class="keyword">end</span>
0061 
0062 
0063 <span class="comment">% force to do only first 1000</span>
0064 CONST.view.maxNumCell = 1000;
0065 
0066 
0067 <span class="keyword">if</span> ~isempty( CONST.view.maxNumCell )
0068     numCells = min( [numCells, CONST.view.maxNumCell] );
0069 <span class="keyword">end</span>
0070 <span class="comment">% debug</span>
0071 <span class="comment">% numCells = min([numCells,5]);</span>
0072 disp( [<span class="string">'Running consensus (max cell number '</span>,<span class="keyword">...</span>
0073     num2str(numCells),<span class="string">')'</span>] );
0074 
0075 <span class="comment">%        ssTot : Keep track of the total size of the tower mosaic.</span>
0076 ssTot = [0,0];
0077 
0078 
0079 <span class="comment">% Manage the waitbar</span>
0080 <span class="comment">%if disp_flag</span>
0081 h = waitbar(0, <span class="string">'Computation'</span> );
0082 <span class="comment">%end</span>
0083 
0084 <span class="comment">% initialize the sum variables</span>
0085 dataImArray = <a href="#_sub5" class="code" title="subfunction data = intInit( numCells )">intInit</a>( numCells );
0086 <span class="comment">%         imSum : Summed up imBW</span>
0087 <span class="comment">%       maskSum : Summed up maskCons</span>
0088 <span class="comment">%     imCellSum : Summed up imCell</span>
0089 <span class="comment">%   maskCellSum : Summed up maskCell</span>
0090 <span class="comment">%    imCellSSum : Summed up imCellS</span>
0091 <span class="comment">%  maskCellSSum : Summed up maskCellS</span>
0092 <span class="comment">%     imNormSum : Summed up Normed Fluor (imBW)</span>
0093 <span class="comment">% imCellNormSum : Summed up Normed Fluor (imCell)</span>
0094 <span class="comment">%         ssTot : Im size of tower mosaic of cell contributing to cons</span>
0095 
0096 
0097 <span class="comment">% loop through the cells to make the consensus image and the mosaic</span>
0098 
0099 
0100 
0101 imArray = cell(1,numCells);
0102 
0103 ii_ = 0;
0104 
0105 
0106 <span class="keyword">for</span> ii = 1:numCells
0107     
0108     <span class="comment">% update status bar</span>
0109     <span class="comment">%if disp_flag</span>
0110     waitbar(ii/numCells,h);
0111     <span class="comment">%end</span>
0112     
0113     
0114     <span class="comment">% load data and get file number</span>
0115     [data, dataImArray.cellArrayNum{ii}] = <a href="#_sub6" class="code" title="subfunction [ data, num_filename ] = intLoader( dirName, filename )">intLoader</a>( dirName, contents(ii).name );
0116     
0117     
0118     
0119     data.CellA = data.CellA(1:skip:end);
0120     
0121     <span class="comment">%%</span>
0122     
0123     <span class="comment">% mag is used to resize the images of the cells to make them larger.</span>
0124     <span class="comment">% the image will be mag X larger in each dimension</span>
0125     mag = 4;
0126     
0127     
0128     <span class="comment">% Compute consensus images for cell in data</span>
0129     
0130     <span class="keyword">if</span> numel(data.CellA) &gt; 4
0131         
0132         
0133         ii_ = ii_ + 1;
0134         
0135         
0136         dataIm = <a href="makeTowerCons.html" class="code" title="function  imData = makeTowerCons( data, CONST, xdim,disp_flag, skip, mag )">makeTowerCons</a>(data,CONST,1,false, skip, mag );
0137         
0138         
0139         <span class="comment">%     imshow([dataIm.towerNorm],[]);</span>
0140         <span class="comment">%     min(dataIm.intWeight)</span>
0141         <span class="comment">%     pause(.2)</span>
0142         <span class="comment">%</span>
0143         <span class="comment">%     if min(dataIm.intWeight) &lt; 0</span>
0144         <span class="comment">%         keyboard;</span>
0145         <span class="comment">%     end</span>
0146         <span class="comment">%</span>
0147         <span class="comment">% Scale images down to the original size</span>
0148         imArray{ii_} = imresize( dataIm.tower, 1/mag);
0149         
0150         <span class="comment">% update the sums</span>
0151         dataImArray = <a href="#_sub3" class="code" title="subfunction dataArray = intUpdate( dataArray, data, jj )">intUpdate</a>( dataImArray, dataIm, ii_  );
0152         
0153     <span class="keyword">end</span>
0154 <span class="keyword">end</span>
0155 
0156 numCells = ii_;
0157 imArray = imArray(1:numCells);
0158 
0159 <span class="comment">% close the status bar</span>
0160 <span class="keyword">if</span> disp_flag
0161     close(h);
0162 <span class="keyword">end</span>
0163 
0164 <span class="comment">% Principal Component Analysis of Grayscale cell tower images</span>
0165 <span class="keyword">if</span> numel( imArray ) &gt; 0
0166     [AA,BB] = <a href="pcanal4.html" class="code" title="function [A,B,imArray] = pcanal(dataCellArray,disp_flag)">pcanal4</a>( imArray, disp_flag );
0167 <span class="keyword">end</span>
0168 
0169 <span class="comment">%% normalize sums to convert sums to means.</span>
0170 dataImArray = <a href="#_sub4" class="code" title="subfunction dataArray = intNormalize( dataArray, numCells )">intNormalize</a>( dataImArray, numCells );
0171 
0172 <span class="comment">%% reform tower images here</span>
0173 <span class="comment">% tmp = towerMergeImages( dataImArray.imCellNorm, dataImArray.maskCell, ssCell, xdim, skip, mag, CONST );</span>
0174 <span class="comment">% Merge the images from the arrays into a single image</span>
0175 T0 = numel( dataImArray.imCell );
0176 
0177 <span class="keyword">if</span>  ~T0
0178     I = [];
0179     kymo = [];
0180     kymoMask = [];
0181     kymoMax = [];
0182     kymoMaskMax = [];
0183     imMosaic = [];
0184     imColor = [];
0185     imBW = [];
0186     imInv = []
0187     imBWunmasked = [];
0188     imBWmask = [];
0189     imMosaic10 = [];
0190     hotPix = [];
0191 <span class="keyword">else</span>
0192     
0193     <span class="keyword">for</span> jj = 1:T0
0194         ssCell{jj} = size(  dataImArray.imCell{jj} );
0195     <span class="keyword">end</span>
0196     
0197     [ bs_, bs_, dataImArray.tower, dataImArray.towerMask ] = <span class="keyword">...</span>
0198         <a href="towerMergeImages.html" class="code" title="function [imColor, imBW, towerIm, maskCons, nx, ny, max_x, max_y ] =towerMergeImages( imCell, maskCell, ssCell, xdim, skip, mag, CONST )">towerMergeImages</a>( dataImArray.imCell, dataImArray.maskCell, ssCell, 1, skip, mag, CONST );
0199     <span class="comment">%dataImArray.tower = dataImArray.tower.*dataImArray.towerMask;</span>
0200     
0201     <span class="comment">% Merge the images from the arrays into a single image</span>
0202     [ bs_, bs_, dataImArray.towerNorm, dataImArray.towerMask ] = <span class="keyword">...</span>
0203         <a href="towerMergeImages.html" class="code" title="function [imColor, imBW, towerIm, maskCons, nx, ny, max_x, max_y ] =towerMergeImages( imCell, maskCell, ssCell, xdim, skip, mag, CONST )">towerMergeImages</a>( dataImArray.imCellNorm, dataImArray.maskCell, ssCell, 1, skip, mag, CONST );
0204     <span class="comment">%dataImArray.towerNorm = dataImArray.towerNorm.*dataImArray.towerMask;</span>
0205     
0206     <span class="comment">%%</span>
0207     numIm = numel( dataImArray.tower );
0208     
0209     <span class="keyword">if</span> numIm  &gt; 0
0210         <span class="comment">%% make the color map for the color image</span>
0211         [ imMosaic, imColor, imBW, imInv, imMosaic10 ] = intDoMakeImage( dataImArray.towerNorm, <span class="keyword">...</span>
0212             dataImArray.towerMask, dataImArray.towerCArray, <span class="keyword">...</span>
0213             dataImArray.ssTot, dataImArray.cellArrayNum, CONST, disp_flag );
0214         <span class="comment">%  imMosaic : Mosaic of towers of cells that make up the consensus image</span>
0215         <span class="comment">%   imColor : Color cons image (w/ black background)</span>
0216         <span class="comment">%      imBW : Grayscale cons image</span>
0217         <span class="comment">%     imInv : Color cons image (w/ white background)</span>
0218         imBWunmasked = dataImArray.towerNorm;
0219         imBWmask     = dataImArray.towerMask;
0220         
0221         <span class="comment">%% make the kymo</span>
0222         <span class="comment">% [ kymo, kymoMask, kymoMax, kymoMaskMax ] = ...</span>
0223         <span class="comment">%     intMakeKymo( dataImArray.imCellNormScale, dataImArray.maskCellScale, ...</span>
0224         <span class="comment">%     disp_flag );</span>
0225         <span class="comment">%      kymo : Consensus Kymograph</span>
0226         <span class="comment">%  kymoMask : Consensus Kymograph Cell mask</span>
0227         
0228         <span class="comment">%% make the kymo</span>
0229         [ kymo, kymoMask, kymoMax, kymoMaskMax ] = <span class="keyword">...</span>
0230             intMakeKymo( dataImArray.imCellNorm, dataImArray.maskCell, <span class="keyword">...</span>
0231             disp_flag );
0232         <span class="comment">%      kymo : Consensus Kymograph</span>
0233         <span class="comment">%  kymoMask : Consensus Kymograph Cell mask</span>
0234         <span class="comment">%% do the kymo fit</span>
0235         [I] = <a href="fitKymo4.html" class="code" title="function [ I ] = fitKymo4( kymo, kymoMask, disp_flag )">fitKymo4</a>( kymo, kymoMask, disp_flag );
0236         <span class="comment">%         I : Fit of intensities to a model for polar localization</span>
0237         
0238         <span class="comment">%hotPix = getHotPixelsCons( dataImArray.imCell, dataImArray.maskCell  );</span>
0239         hotPix = [] ;
0240         <span class="comment">%% Make hot pixel</span>
0241         
0242         
0243     <span class="keyword">else</span>
0244         I = [];
0245         kymo = [];
0246         kymoMask = [];
0247         kymoMax = [];
0248         kymoMaskMax = [];
0249         imMosaic = [];
0250         imColor = [];
0251         imBW = [];
0252         imInv = []
0253     <span class="keyword">end</span>
0254 <span class="keyword">end</span>
0255 
0256 <span class="keyword">end</span>
0257 
0258 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0259 <span class="comment">%</span>
0260 <span class="comment">% intDoMakeImage</span>
0261 <span class="comment">%</span>
0262 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0263 <a name="_sub1" href="#_subfunctions" class="code">function [ imMosaic, imColor, imBW, imInv, imMosaic10] = </a><span class="keyword">...</span>
0264     intDoMakeImage( imSum, maskSum, cellArray, ssTot, cellArrayNum, <span class="keyword">...</span>
0265     CONST, disp_flag )
0266 
0267 
0268 
0269 
0270 numCells = numel( cellArray );
0271 
0272 
0273 <span class="comment">% cellArrayPos: location in the image of each panel of the mosaic.</span>
0274 cellArrayPos = cell(1,numCells);
0275 
0276 <span class="comment">% make the color map for the color image</span>
0277 <span class="comment">%persistent colormap_;</span>
0278 <span class="comment">%if isempty( colormap_ )</span>
0279 colormap_ = jet(256);
0280 <span class="comment">%end</span>
0281 
0282 
0283 imTmp = 255*<a href="doColorMap.html" class="code" title="function im_ = doColorMap( im, colormap_ )">doColorMap</a>( ag(imSum, min(imSum( maskSum&gt;.95 )), max(imSum( maskSum&gt;.95 )) ), colormap_ );
0284 mask3 = cat( 3, maskSum, maskSum, maskSum );
0285 imColor = uint8(uint8( double(imTmp).*mask3));
0286 imBW  = uint8( double(ag(imSum, min(imSum( maskSum&gt;.95 )), max(imSum( maskSum&gt;.95 )) )) .* maskSum );
0287 
0288 imTmp = 255*<a href="doColorMap.html" class="code" title="function im_ = doColorMap( im, colormap_ )">doColorMap</a>( ag(imSum, min(imSum( maskSum&gt;.95 )), max(imSum( maskSum&gt;.95 )) ), 1-colormap_ );
0289 mask3 = cat( 3, maskSum, maskSum, maskSum );
0290 imInv = 255-uint8(uint8( double(imTmp).*mask3));
0291 
0292 <span class="keyword">if</span> disp_flag
0293     figure(5)
0294     clf;
0295     imshow( imColor);
0296     drawnow;
0297 <span class="keyword">end</span>
0298 
0299 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0300 <span class="keyword">if</span> disp_flag
0301     figure(1);
0302 <span class="keyword">end</span>
0303 
0304 del = 1;
0305 
0306 <span class="keyword">if</span> CONST.view.falseColorFlag
0307     imMosaic = uint8(zeros( [ssTot(1), ssTot(2), 3] )) + del*255;
0308 <span class="keyword">else</span>
0309     imMosaic = uint8(zeros( [ssTot(1), ssTot(2), 3] ));
0310 <span class="keyword">end</span>
0311 
0312 
0313 colPos = 1;
0314 
0315 width10 = 0;
0316 time10  = 0;
0317 
0318 <span class="keyword">for</span> ii = 1:numCells
0319     
0320     
0321     ss = size(cellArray{ii});
0322     
0323     
0324     <span class="keyword">if</span> ii &lt;= 10
0325         width10 = width10 + ss(2);
0326         time10  = max([ss(1),time10]);
0327     <span class="keyword">end</span>
0328     
0329     imMosaic(1:ss(1), colPos:(colPos+ss(2)-1), :) = cellArray{ii};
0330     
0331     cellArrayPos{ii} = colPos + ss(2)/2;
0332     
0333     
0334     colPos = colPos + ss(2);
0335     
0336 <span class="keyword">end</span>
0337 
0338 imMosaic10 = imMosaic( 1:time10, 1:width10, : );
0339 
0340 <span class="keyword">if</span> disp_flag
0341     clf;
0342     imshow( imMosaic );
0343     
0344     <span class="keyword">if</span> CONST.view.falseColorFlag
0345         cc = <span class="string">'w'</span>;
0346     <span class="keyword">else</span>
0347         cc = <span class="string">'b'</span>;
0348     <span class="keyword">end</span>
0349     
0350     
0351     <span class="keyword">for</span> ii = 1:numCells
0352         text( cellArrayPos{ii}, 0, num2str(cellArrayNum{ii}), <span class="string">'Color'</span>, cc, <span class="keyword">...</span>
0353             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span> );
0354     <span class="keyword">end</span>
0355 <span class="keyword">end</span>
0356 
0357 <span class="comment">%'hi'</span>
0358 <span class="keyword">end</span>
0359 
0360 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0361 <span class="comment">%</span>
0362 <span class="comment">% intMakeKymo</span>
0363 <span class="comment">%</span>
0364 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0365 <a name="_sub2" href="#_subfunctions" class="code">function [ kymo,kymoMask,kymoMax, kymoMaskMax ] = </a><span class="keyword">...</span>
0366     intMakeKymo( imCellS, maskCellS, disp_flag )
0367 
0368 T0 = numel( imCellS );
0369 mag = 4;
0370 
0371 <span class="keyword">if</span> T0 &gt; 0
0372     
0373     ss    = size( imCellS{1} );
0374     ssMax = size( imresize(imCellS{1}, 1/mag) );
0375     
0376     kymo    = zeros( [ss(2), T0] );
0377     kymoMax = zeros( [ssMax(2), T0] );
0378     
0379     kymoMask    = kymo;
0380     kymoMaskMax = kymoMax;
0381     
0382     <span class="keyword">for</span> ii = 1:T0
0383         maskCellS{ii}( isnan( maskCellS{ii} ) ) = 0;
0384         imCellS{ii}( isnan( imCellS{ii} ) )     = 0;
0385         
0386         <span class="comment">%kymo(:,ii) = sum(maskCellS{ii}.*imCellS{ii},1)./sum(maskCellS{ii});</span>
0387         kymo(:,ii) = sum(maskCellS{ii}.*imCellS{ii},1);
0388         kymoMask(:,ii) = sum(maskCellS{ii},1);
0389         
0390         kymoMax(:,ii)       = max(imresize( maskCellS{ii}.*imCellS{ii},<span class="keyword">...</span>
0391             1/mag ), [], 1);
0392         kymoMaskMax(:,ii)   = max(imresize( maskCellS{ii}, 1/mag ),<span class="keyword">...</span>
0393             [], 1);
0394         
0395     <span class="keyword">end</span>
0396 <span class="keyword">end</span>
0397 
0398 <span class="keyword">if</span> disp_flag
0399     figure(7);
0400     clf;
0401     
0402     ss = size( kymo );
0403     tt = (0:(ss(2)-1))/(ss(2)-1);
0404     xx = (0:(ss(1)-1))/(ss(1)-1);
0405     
0406     
0407     imagesc( tt,xx, <a href="colorize.html" class="code" title="function  imTmp_ = colorize( im, mask, colormap_, back )">colorize</a>(kymo,kymoMask,[],[0.33,0.33,0.33]) );
0408     set(gca, <span class="string">'YDir'</span>, <span class="string">'normal'</span> );
0409     xlabel( <span class="string">'Time (Cell Cycle)'</span>);
0410     ylabel( <span class="string">'Relative Long Axis Position'</span>);
0411 <span class="keyword">end</span>
0412 
0413 <span class="keyword">end</span>
0414 
0415 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0416 <span class="comment">%</span>
0417 <span class="comment">% intUpdate</span>
0418 <span class="comment">%</span>
0419 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0420 <a name="_sub3" href="#_subfunctions" class="code">function dataArray = intUpdate( dataArray, data, jj )</a>
0421 
0422 
0423 T0 = numel( data.imCell );
0424 
0425 <span class="keyword">if</span> isempty( dataArray.sumWeight );
0426     dataArray.sumWeight    = zeros(1,T0);
0427     dataArray.sumWeightMin = 0;
0428     
0429     dataArray.sumWeightS    = zeros(1,T0);
0430     dataArray.sumWeightSMin = 0;
0431 <span class="keyword">end</span>
0432 
0433 
0434 <span class="comment">% update im and mask sum</span>
0435 <span class="keyword">if</span> isempty( dataArray.tower )
0436     dataArray.tower        = double( data.towerRaw );
0437     dataArray.sumWeightMin = min(data.intWeight);
0438     
0439     dataArray.towerNorm    = dataArray.sumWeightMin *<span class="keyword">...</span>
0440         double( data.towerNormRaw );
0441     
0442     dataArray.towerMask    = double( data.towerMask );
0443 <span class="keyword">else</span>
0444     dSumWeightMin = min(data.intWeight);
0445     
0446     dataArray.tower        = dataArray.tower     + double( data.towerRaw );
0447     dataArray.towerNorm    = dataArray.towerNorm + <span class="keyword">...</span>
0448         dSumWeightMin * double( data.towerNormRaw );
0449     
0450     dataArray.towerMask    = dataArray.towerMask + double( data.towerMask );
0451     
0452     dataArray.sumWeightMin = dataArray.sumWeightMin + dSumWeightMin;
0453 <span class="keyword">end</span>
0454 
0455 ss = size(data.imCell{1});
0456 
0457 dataArray.ssTot = [ max([dataArray.ssTot(1),ss(1)]),<span class="keyword">...</span>
0458     dataArray.ssTot(2)+ss(2) ];
0459 
0460 <span class="keyword">if</span> isempty( dataArray.imCell )
0461     dataArray.imCell         = data.imCell;
0462     dataArray.imCellNorm     = data.imCellNorm;
0463     dataArray.maskCell       = data.maskCell;
0464     dataArray.imCellScale    = data.imCellScale;
0465     dataArray.maskCellScale  = data.maskCellScale;
0466     
0467     <span class="keyword">for</span> ii = 1:T0
0468         dataArray.imCellNorm{ii} = data.imCellNorm{ii} <span class="keyword">...</span>
0469             * data.intWeight(ii);
0470         dataArray.imCellNormScale{ii} = data.imCellNormScale{ii} <span class="keyword">...</span>
0471             * data.intWeightS(ii);
0472     <span class="keyword">end</span>
0473     
0474     dataArray.sumWeight = data.intWeight;
0475     dataArray.sumWeightS = data.intWeightS;
0476     
0477 <span class="keyword">else</span>
0478     <span class="keyword">for</span> ii = 1:T0
0479         dataArray.imCell{        ii}  = dataArray.imCell{        ii} <span class="keyword">...</span>
0480             + data.imCell{    ii};
0481         dataArray.maskCell{      ii}  = dataArray.maskCell{      ii} <span class="keyword">...</span>
0482             + data.maskCell{  ii};
0483         dataArray.imCellScale{   ii}  = dataArray.imCellScale{   ii} <span class="keyword">...</span>
0484             + data.imCellScale{   ii};
0485         dataArray.maskCellScale{ ii}  = dataArray.maskCellScale{ ii} <span class="keyword">...</span>
0486             + data.maskCellScale{ ii};
0487         dataArray.imCellNorm{    ii}  = dataArray.imCellNorm{    ii} <span class="keyword">...</span>
0488             + data.imCellNorm{ii} * data.intWeight(ii);
0489         dataArray.imCellNormScale{    ii}  = dataArray.imCellNormScale{    ii} <span class="keyword">...</span>
0490             + data.imCellNormScale{ii} * data.intWeightS(ii);
0491     <span class="keyword">end</span>
0492     
0493     dataArray.sumWeight = dataArray.sumWeight + data.intWeight;
0494     dataArray.sumWeightS = dataArray.sumWeightS + data.intWeightS;
0495     
0496 <span class="keyword">end</span>
0497 
0498 dataArray.towerCArray{   jj} = data.towerC;
0499 dataArray.towerArray{    jj} = data.tower;
0500 dataArray.towerNormArray{jj} = data.towerNorm;
0501 
0502 dataArray.intWeightMinArray(jj) = min(data.intWeight);
0503 
0504 <span class="keyword">end</span>
0505 
0506 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0507 <span class="comment">%</span>
0508 <span class="comment">% intNormalize</span>
0509 <span class="comment">%</span>
0510 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0511 <a name="_sub4" href="#_subfunctions" class="code">function dataArray = intNormalize( dataArray, numCells )</a>
0512 
0513 dataArray.numCells = numCells;
0514 
0515 
0516 dataArray.towerCArray       = dataArray.towerCArray(1:numCells);
0517 dataArray.towerArray        = dataArray.towerArray(1:numCells);
0518 dataArray.towerNormArray    = dataArray.towerNormArray(1:numCells);
0519 dataArray.intWeightMinArray = dataArray.intWeightMinArray(1:numCells);
0520 dataArray.cellArrayNum      = dataArray.cellArrayNum(1:numCells);
0521 
0522 
0523 
0524 
0525 
0526 
0527 T0 = numel( dataArray.imCell );
0528 
0529 dataArray.tower     = dataArray.tower    /dataArray.numCells;
0530 dataArray.towerMask = dataArray.towerMask/dataArray.numCells;
0531 dataArray.towerNorm = dataArray.towerNorm/dataArray.sumWeightMin;
0532 
0533 <span class="keyword">for</span> ii = 1:T0
0534     dataArray.imCellSum{    ii}  = dataArray.imCell{        ii}<span class="keyword">...</span>
0535         /dataArray.numCells;
0536     dataArray.maskCell{      ii}  = dataArray.maskCell{     ii}<span class="keyword">...</span>
0537         /dataArray.numCells;
0538     dataArray.imCellScale{   ii}  = dataArray.imCellScale{  ii}<span class="keyword">...</span>
0539         /dataArray.numCells;
0540     dataArray.maskCellScale{ ii}  = dataArray.maskCellScale{ii}<span class="keyword">...</span>
0541         /dataArray.numCells;
0542     dataArray.imCellNorm{    ii}  = dataArray.imCellNorm{   ii}<span class="keyword">...</span>
0543         /dataArray.sumWeight(ii);
0544     dataArray.imCellNormScale{    ii}  = dataArray.imCellNormScale{   ii}<span class="keyword">...</span>
0545         /dataArray.sumWeightS(ii);
0546 <span class="keyword">end</span>
0547 <span class="keyword">end</span>
0548 
0549 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0550 <span class="comment">%</span>
0551 <span class="comment">% intInit</span>
0552 <span class="comment">%</span>
0553 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0554 <a name="_sub5" href="#_subfunctions" class="code">function data = intInit( numCells )</a>
0555 
0556 data = [];
0557 <span class="comment">% Initialize the arrays for the images.</span>
0558 <span class="comment">% imColorArray : (im tower) Colorized cropped cons image of a single cell</span>
0559 data.towerCArray = cell(1,numCells); <span class="comment">%</span>
0560 
0561 <span class="comment">%      imArray : Cell Array stack of Grayscale tower images that are mag = 1.</span>
0562 data.towerArray      = cell(1,numCells);
0563 data.towerNormArray      = cell(1,numCells);
0564 data.intWeightMinArray      = zeros( 1,numCells);
0565 
0566 <span class="comment">% cellArrayNum : Cell file number cell array</span>
0567 data.cellArrayNum = cell(1,numCells);
0568 
0569 
0570 data.tower           = [];
0571 data.towerNorm       = [];
0572 data.towerMask       = [];
0573 
0574 data.imCell          = [];
0575 data.imCellNorm      = [];
0576 data.maskCell        = [];
0577 
0578 data.imCellScale     = [];
0579 data.imCellNormScale = [];
0580 data.maskCellScale   = [];
0581 
0582 data.sumWeight       = [];
0583 data.sumWeightMin    = [];
0584 
0585 data.sumWeightS      = [];
0586 data.sumWeightSMin   = [];
0587 
0588 data.numCells        = numCells;
0589 
0590 data.ssTot           = [0, 0];
0591 
0592 <span class="keyword">end</span>
0593 
0594 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0595 <span class="comment">%</span>
0596 <span class="comment">% intLoader</span>
0597 <span class="comment">%</span>
0598 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0599 <a name="_sub6" href="#_subfunctions" class="code">function [ data, num_filename ] = intLoader( dirName, filename )</a>
0600 
0601 data = load( [dirName, filename] );
0602 
0603 lpos =  max(find(filename == <span class="string">'l'</span>));
0604 ppos =  min(find(filename == <span class="string">'.'</span>));
0605 
0606 <span class="keyword">if</span> isempty( lpos ) || isempty( ppos )
0607     disp(<span class="string">'Error in makeFrameStripeMosaic'</span> );
0608     <span class="keyword">return</span>;
0609 <span class="keyword">else</span>
0610     num_filename = floor(str2num(filename(lpos+1:ppos-1)));
0611 <span class="keyword">end</span>
0612 
0613 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 23-Feb-2016 13:44:44 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>