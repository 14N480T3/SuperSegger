<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of trackOptiAlignPad</title>
  <meta name="keywords" content="trackOptiAlignPad">
  <meta name="description" content="trackOptiAlignPad : aligns images to correct for microscope drift">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerRelease</a> &gt; <a href="index.html">batch</a> &gt; trackOptiAlignPad.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerRelease/batch&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>trackOptiAlignPad
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>trackOptiAlignPad : aligns images to correct for microscope drift</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function crop_box = trackOptiAlignPad(dirname_, CROP_FLAG, M, CONST) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> trackOptiAlignPad : aligns images to correct for microscope drift
 using the phase images. To keep as much data as possible, instead of
 cropping the resulting images it builds a larger image
 that encompases all drift positions.  It saves the alignment information
 in a file called crop_box.mat

 INPUT :
       dirname_ : folder were .tif image files in NIS format are contained
       CROP_FLAG : if 1  then cropper is : [ceil(1+maxs(1)),ceil(1+maxs(2)),...
                   floor(ss(1)+mins(1)),floor(ss(2)+mins(2))]
                   else it is  cropper = [1,1,ss(1),ss(2)];
                   default is 1
       CONST : segmentation constantsS
 OUTPUT :
       crop_box : information about alignement

 Copyright (C) 2016 Wiggins Lab
 University of Washington, 2016
 This file is part of SuperSeggerOpti.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="MakeFileName.html" class="code" title="function name = MakeFileName( nameInfo )">MakeFileName</a>	MakeFileName converts from nameInfo to original file name</li><li><a href="ReadFileName.html" class="code" title="function nameInfo = ReadFileName( str )">ReadFileName</a>	ReadFileName extracts the numbers after t,x,y,z in a string *t*c*xy*z*</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="BatchSuperSeggerOpti.html" class="code" title="function BatchSuperSeggerOpti(dirname_,skip,clean_flag,res,SEGMENT_FLAG)">BatchSuperSeggerOpti</a>	BatchSuperSeggerOpti runs everything from start to finish,</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function crop_box = intFrameAlignXY( CROP_FLAG, SHOW_FLAG, nt, nz, nc,</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function crop_box = trackOptiAlignPad(dirname_, CROP_FLAG, M, CONST)</a>
0002 <span class="comment">% trackOptiAlignPad : aligns images to correct for microscope drift</span>
0003 <span class="comment">% using the phase images. To keep as much data as possible, instead of</span>
0004 <span class="comment">% cropping the resulting images it builds a larger image</span>
0005 <span class="comment">% that encompases all drift positions.  It saves the alignment information</span>
0006 <span class="comment">% in a file called crop_box.mat</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% INPUT :</span>
0009 <span class="comment">%       dirname_ : folder were .tif image files in NIS format are contained</span>
0010 <span class="comment">%       CROP_FLAG : if 1  then cropper is : [ceil(1+maxs(1)),ceil(1+maxs(2)),...</span>
0011 <span class="comment">%                   floor(ss(1)+mins(1)),floor(ss(2)+mins(2))]</span>
0012 <span class="comment">%                   else it is  cropper = [1,1,ss(1),ss(2)];</span>
0013 <span class="comment">%                   default is 1</span>
0014 <span class="comment">%       CONST : segmentation constantsS</span>
0015 <span class="comment">% OUTPUT :</span>
0016 <span class="comment">%       crop_box : information about alignement</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% Copyright (C) 2016 Wiggins Lab</span>
0019 <span class="comment">% University of Washington, 2016</span>
0020 <span class="comment">% This file is part of SuperSeggerOpti.</span>
0021 
0022 <span class="keyword">if</span> ~exist(<span class="string">'CROP_FLAG'</span>, <span class="string">'var'</span>) || isempty( CROP_FLAG )
0023     CROP_FLAG = 1;
0024 <span class="keyword">end</span>
0025 
0026 <span class="keyword">if</span> ~exist(<span class="string">'M'</span>, <span class="string">'var'</span>) || isempty( M )
0027     M = 0;
0028 <span class="keyword">end</span>
0029 
0030 precision = 100;
0031 
0032 <span class="keyword">if</span> ~isempty(dirname_)
0033     file_filter = <span class="string">'*.tif'</span>;
0034     
0035     dirseperator = filesep;
0036     
0037     dirname = [dirname_,dirseperator];
0038     
0039     contents=dir([dirname file_filter]);
0040     num_im = numel( contents );
0041     
0042     nt  = [];
0043     nc  = [];
0044     nxy = [];
0045     nz  = [];
0046     
0047     <span class="keyword">for</span> i = 1:num_im
0048         
0049         nameInfo = <a href="ReadFileName.html" class="code" title="function nameInfo = ReadFileName( str )">ReadFileName</a>(contents(i).name);
0050         
0051         
0052         nt  = [nt, nameInfo.npos(1,1)];
0053         nc  = [nc, nameInfo.npos(2,1)];
0054         nxy = [nxy,nameInfo.npos(3,1)];
0055         nz  = [nz, nameInfo.npos(4,1)];
0056         
0057         
0058     <span class="keyword">end</span>
0059     
0060     nt  = sort(unique(nt));
0061     nc  = sort(unique(nc));
0062     nxy = sort(unique(nxy));
0063     nz  = sort(unique(nz));
0064     
0065     <span class="keyword">if</span> dirname(1) == <span class="string">'.'</span>
0066         targetd = [dirname,<span class="string">'align'</span>,dirseperator];
0067     <span class="keyword">else</span>
0068         targetd = [dirname_,<span class="string">'_align'</span>,dirseperator];
0069     <span class="keyword">end</span>
0070     
0071     mkdir(targetd);
0072     
0073     num_xy = numel(nxy);
0074     
0075     <span class="keyword">if</span> (M&gt;0) &amp;&amp; (num_xy&gt;1)
0076         SHOW_FLAG = false;
0077     <span class="keyword">else</span>
0078         SHOW_FLAG = true;
0079         M = 0;
0080     <span class="keyword">end</span>
0081     
0082     
0083     crop_box = cell(1, num_xy);
0084     
0085     
0086     parfor(jj=1:num_xy, M)
0087     <span class="comment">%for jj=1:num_xy</span>
0088         nnxy = nxy(jj);
0089         crop_box{jj} = <a href="#_sub1" class="code" title="subfunction crop_box = intFrameAlignXY( CROP_FLAG, SHOW_FLAG, nt, nz, nc, ">intFrameAlignXY</a>( CROP_FLAG, SHOW_FLAG, nt, nz, nc, nnxy, <span class="keyword">...</span>
0090             dirname, targetd, nameInfo, precision, CONST );
0091     <span class="keyword">end</span>
0092 <span class="keyword">end</span>
0093 <span class="keyword">end</span>
0094 
0095 
0096 
0097 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0098 <span class="comment">%</span>
0099 <span class="comment">% Parallelize frame alignment.</span>
0100 <span class="comment">%</span>
0101 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0102 <a name="_sub1" href="#_subfunctions" class="code">function crop_box = intFrameAlignXY( CROP_FLAG, SHOW_FLAG, nt, nz, nc, </a><span class="keyword">...</span>
0103     nnxy, dirname, targetd, nameInfo, precision, CONST )
0104 
0105 
0106 
0107 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0108 <span class="comment">% FOCUS_NUM_LIM = 5;</span>
0109 <span class="comment">% ERR_LIM = 0.7;</span>
0110 <span class="comment">%%%%%%%%%%%%%%%</span>
0111 FOCUS_NUM_LIM = 0;
0112 ERR_LIM = 1000000;
0113 
0114 <span class="keyword">if</span> SHOW_FLAG
0115     h = waitbar(0,<span class="string">'aligning frames: '</span>);
0116 <span class="keyword">end</span>
0117 
0118 tt = 1;
0119 
0120 nnt = numel( nt );
0121 outlast = [];
0122 
0123 OutArray   = zeros( nnt, 2);
0124 FocusArray = zeros( nnt, 1);
0125 
0126 countt   = 0;
0127 
0128 nz = sort(nz);
0129 
0130 
0131 <span class="comment">%%%</span>
0132 iz = 1;
0133 
0134 nnz = numel(nz);
0135 nnz2 = ceil(nnz/2);
0136 nz = [nz(nnz2), nz([1:(nnz2-1),(nnz2+1):nnz])];
0137 
0138 initFlag = false;
0139 
0140 <span class="keyword">for</span> it = nt;
0141     <span class="keyword">if</span> SHOW_FLAG
0142         waitbar(countt/nnt,h);
0143     <span class="keyword">end</span>
0144     
0145     countt = countt+1;
0146     
0147     <span class="keyword">for</span> iz = nz
0148         <span class="keyword">for</span> ic = nc
0149             
0150             nameInfo.npos(:,1) = [it; ic; nnxy; iz];
0151             in_name =  [dirname, <a href="MakeFileName.html" class="code" title="function name = MakeFileName( nameInfo )">MakeFileName</a>(nameInfo)];
0152             disp([<span class="string">'Image name: '</span>,in_name]);
0153             im = imread( in_name );
0154             
0155             
0156             <span class="keyword">if</span> numel(size(im)) &gt; 2
0157                 disp(<span class="string">'Nate you fucking idiot! These images are color.'</span>);
0158                 im = squeeze(im(:,:,1));
0159                 
0160             <span class="keyword">end</span>
0161             
0162             <span class="keyword">if</span> (ic == nc(1)) &amp;&amp; (iz == nnz2 | iz == -1)
0163                 <span class="keyword">if</span> ~initFlag
0164                     phaseB = im;
0165                 <span class="keyword">end</span>
0166                 [out,errNum,focusNum] = intAlignIm( im, phaseB, precision );
0167                 disp([<span class="string">'focusNum: '</span>,num2str(focusNum),<span class="string">' errNum: '</span>,num2str(errNum)]);
0168                 
0169                 FOCUS_FLAG = (focusNum &gt; FOCUS_NUM_LIM) &amp; (errNum &lt; ERR_LIM);
0170                 <span class="keyword">if</span> FOCUS_FLAG
0171                     initFlag = true;
0172                     OutArray(countt,:) = out(3:4);
0173                     FocusArray(countt) = true;
0174                 <span class="keyword">end</span>
0175             <span class="keyword">end</span>
0176             
0177             im = intShiftIm(im, out);
0178             
0179             <span class="keyword">if</span> SHOW_FLAG
0180                 <span class="keyword">if</span> ic == nc(1)
0181                     <span class="keyword">if</span> ic&gt;0
0182                         figure(ic)
0183                         clf;
0184                         imshow( cat( 3, ag(im), <span class="keyword">...</span>
0185                             double(FOCUS_FLAG)*(0.5*ag(im)+0.5*ag(phaseB)), <span class="keyword">...</span>
0186                             double(FOCUS_FLAG)*ag(phaseB) ));
0187                     <span class="keyword">end</span>
0188                 <span class="keyword">else</span>
0189                     backer = .8*ag(phaseB);
0190                     backer0 = backer;
0191                     fluor  = ag(uint16(im-median(im(:))));
0192                     
0193                     figure(ic)
0194                     clf;
0195                     <span class="keyword">if</span> mod(ic,2) == 0
0196                         imshow( cat( 3, backer, backer0+fluor, backer0));
0197                     <span class="keyword">else</span>
0198                         imshow( cat( 3, backer+fluor, backer0, backer0));
0199                     <span class="keyword">end</span>
0200                 <span class="keyword">end</span>
0201                 drawnow;
0202             <span class="keyword">end</span>
0203             
0204             
0205             <span class="keyword">if</span> FOCUS_FLAG
0206                 <span class="keyword">if</span> ic == nc(1)
0207                     phaseB = im;
0208                 <span class="keyword">end</span>
0209                 
0210                 out_name = [targetd, <a href="MakeFileName.html" class="code" title="function name = MakeFileName( nameInfo )">MakeFileName</a>(nameInfo)];
0211                 <span class="comment">%imwrite(uint16(im), out_name ,'tif','Compression', 'none');</span>
0212                 
0213             <span class="keyword">else</span>
0214                 disp( [<span class="string">'Skipping frame: '</span>, in_name] );
0215             <span class="keyword">end</span>
0216         <span class="keyword">end</span>
0217     <span class="keyword">end</span>
0218     
0219     size( phaseB )
0220 <span class="keyword">end</span>
0221 
0222 <span class="comment">%% in the pad version we add a pad region to the outside of the image.</span>
0223 ss = size(phaseB);
0224 
0225 maxy = ceil( max(-OutArray(:,1)));
0226 maxx = ceil( max(-OutArray(:,2)));
0227 miny = floor(min(-OutArray(:,1)));
0228 minx = floor(min(-OutArray(:,2)));
0229 
0230 sspad = [ss(1)+maxy-miny,ss(2)+maxx-minx];
0231 countt   = 0;
0232 initFlag = false;
0233 
0234 
0235 crop_box = [OutArray,OutArray];
0236 crop_box(:,1) = -crop_box(:,1) + 1-miny;
0237 crop_box(:,2) = -crop_box(:,2) + 1-minx;
0238 crop_box(:,3) = crop_box(:,1) + ss(1);
0239 crop_box(:,4) = crop_box(:,2) + ss(2);
0240 
0241 <span class="keyword">for</span> it = nt;
0242     <span class="keyword">if</span> SHOW_FLAG
0243         waitbar(countt/nnt,h);
0244     <span class="keyword">end</span>
0245     
0246     countt = countt+1;
0247     
0248     <span class="keyword">for</span> iz = nz
0249         <span class="keyword">for</span> ic = nc
0250             
0251             nameInfo.npos(:,1) = [it; ic; nnxy; iz];
0252             in_name =  [dirname, <a href="MakeFileName.html" class="code" title="function name = MakeFileName( nameInfo )">MakeFileName</a>(nameInfo)];
0253             disp([<span class="string">'Image name: '</span>,in_name]);
0254             im_ = imread( in_name );
0255             
0256             
0257             im = zeros( sspad, class(im_) ) + mean( im_(:) );
0258             im( (1-miny):(ss(1)-miny), (1-minx):(ss(2)-minx) ) = im_;
0259             
0260             
0261             out = [0,0,OutArray(countt,:)];
0262             im = intShiftIm(im, out + CONST.imAlign.out{ic} - <span class="keyword">...</span>
0263                 CONST.imAlign.out{1});
0264             
0265             <span class="keyword">if</span> ~initFlag
0266                 phaseB = im;
0267             <span class="keyword">end</span>
0268             
0269             <span class="keyword">if</span> SHOW_FLAG
0270                 <span class="keyword">if</span> ic == nc(1)
0271                     figure(ic)
0272                     clf;
0273                     imshow( cat( 3, ag(im), <span class="keyword">...</span>
0274                         double(FOCUS_FLAG)*(0.5*ag(im)+0.5*ag(phaseB)), <span class="keyword">...</span>
0275                         double(FOCUS_FLAG)*ag(phaseB) ));
0276                 <span class="keyword">else</span>
0277                     backer = .8*ag(phaseB);
0278                     backer0 = backer;
0279                     fluor  = ag(uint16(im-median(im(:))));
0280                     
0281                     figure(ic)
0282                     clf;
0283                     <span class="keyword">if</span> mod(ic,2) == 0
0284                         imshow( cat( 3, backer, backer0+fluor, backer0));
0285                     <span class="keyword">else</span>
0286                         imshow( cat( 3, backer+fluor, backer0, backer0));
0287                     <span class="keyword">end</span>
0288                 <span class="keyword">end</span>
0289                 drawnow;               
0290                 hold on;
0291                 xxxx = [crop_box(countt,2),<span class="keyword">...</span>
0292                     crop_box(countt,2),<span class="keyword">...</span>
0293                     crop_box(countt,4),<span class="keyword">...</span>
0294                     crop_box(countt,4),<span class="keyword">...</span>
0295                     crop_box(countt,2)];
0296                 yyyy = [crop_box(countt,1),<span class="keyword">...</span>
0297                     crop_box(countt,3),<span class="keyword">...</span>
0298                     crop_box(countt,3),<span class="keyword">...</span>
0299                     crop_box(countt,1),<span class="keyword">...</span>
0300                     crop_box(countt,1)];
0301                 
0302                 plot( xxxx,yyyy,<span class="string">'y'</span>);
0303             <span class="keyword">end</span>
0304             
0305             
0306             <span class="keyword">if</span> FocusArray(countt)
0307                 out_name = [targetd, <a href="MakeFileName.html" class="code" title="function name = MakeFileName( nameInfo )">MakeFileName</a>(nameInfo)];
0308                 imwrite(uint16(im), out_name ,<span class="string">'tif'</span>,<span class="string">'Compression'</span>, <span class="string">'none'</span>);
0309                 initFlag = true;
0310                 
0311                 <span class="keyword">if</span> ic == nc(1)
0312                     phaseB = im;
0313                 <span class="keyword">end</span>
0314             <span class="keyword">else</span>
0315                 disp( [<span class="string">'Skipping frame: '</span>, in_name] );
0316             <span class="keyword">end</span>
0317         <span class="keyword">end</span>
0318     <span class="keyword">end</span>
0319     
0320 <span class="keyword">end</span>
0321 
0322 <span class="comment">% done shifting the frames.</span>
0323 
0324 
0325 
0326 
0327 <span class="keyword">if</span> SHOW_FLAG
0328     close(h);
0329 <span class="keyword">end</span>
0330 
0331 
0332 
0333 mins = min(-OutArray);
0334 maxs = max(-OutArray);
0335 
0336 ss = size(im);
0337 
0338 <span class="keyword">if</span> CROP_FLAG
0339     cropper = [ceil(1+maxs(1)),ceil(1+maxs(2)),<span class="keyword">...</span>
0340         floor(ss(1)+mins(1)),floor(ss(2)+mins(2))]
0341 <span class="keyword">else</span>
0342     cropper = [1,1,ss(1),ss(2)];
0343 <span class="keyword">end</span>
0344 
0345 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0346 <span class="keyword">if</span> SHOW_FLAG
0347     h = waitbar(0,<span class="string">'cropping frames: '</span>);
0348 <span class="keyword">end</span>
0349 
0350 tt = 1;
0351 
0352 countt   = 0;
0353 
0354 <span class="keyword">for</span> it = nt;
0355     <span class="keyword">if</span> SHOW_FLAG
0356         waitbar(countt/nnt,h);
0357     <span class="keyword">end</span>
0358     
0359     countt = countt+1;
0360     
0361     <span class="keyword">for</span> iz = nz;
0362         <span class="keyword">for</span> ic = nc;
0363             
0364             <span class="comment">%if ic == 1</span>
0365             <span class="comment">%    nz_ = nz;</span>
0366             <span class="comment">%else</span>
0367             <span class="comment">%    nz_ = 1;</span>
0368             <span class="comment">%end</span>
0369             
0370             <span class="comment">%for iz = nz_;</span>
0371             nameInfo.npos(:,1) = [it; ic; nnxy; iz];
0372             out_name = [targetd, <a href="MakeFileName.html" class="code" title="function name = MakeFileName( nameInfo )">MakeFileName</a>(nameInfo)];
0373             
0374             <span class="keyword">if</span> exist( out_name, <span class="string">'file'</span> );
0375                 im = imread( out_name );
0376                 
0377                 <span class="comment">%out_name = [targetd, MakeFileName(nameInfo)]</span>
0378                 imwrite(im(cropper(1):cropper(3),cropper(2):cropper(4)),<span class="keyword">...</span>
0379                     [out_name] ,<span class="string">'tif'</span>,<span class="string">'Compression'</span>, <span class="string">'none'</span>);
0380             <span class="keyword">end</span>
0381         <span class="keyword">end</span>
0382         
0383     <span class="keyword">end</span>
0384 <span class="keyword">end</span>
0385 
0386 <span class="keyword">if</span> SHOW_FLAG
0387     close(h);
0388 <span class="keyword">end</span>
0389 
0390 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 23-Feb-2016 16:32:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>