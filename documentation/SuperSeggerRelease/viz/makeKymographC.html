<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of makeKymographC</title>
  <meta name="keywords" content="makeKymographC">
  <meta name="description" content="makeKymographC creates a kymograph for given cell.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerRelease</a> &gt; <a href="index.html">viz</a> &gt; makeKymographC.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerRelease/viz&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>makeKymographC
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>makeKymographC creates a kymograph for given cell.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [Kymo,ll1,f1mm,f2mm] = makeKymographC( data, disp_flag, CONST ); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> makeKymographC creates a kymograph for given cell.
 A kymograph shows the fluorescence of the cell along the long axis 
 of the cell, with time.
  
 INPUT :
       data : cell data file
       disp_flag : 1 to display image, 0 to not display image
       CONST : segmentation parameters
 OUTPUT :
       Kymo: Kymo has images at .r .g and .b fields. The combination of
       which produces the kymgraph.
       ll1:  ? does not seem to be set anywhere
       f1mm: is the green channel kymogrpah
       f2mm: is the red channel kymograph
   
 Copyright (C) 2016 Wiggins Lab 
 University of Washington, 2016
 This file is part of SuperSeggerOpti.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="doColorMap.html" class="code" title="function im_ = doColorMap( im, colormap_ )">doColorMap</a>	doColorMap : ?</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="makeKymoMosaic.html" class="code" title="function makeKymoMosaic (dirname, CONST)">makeKymoMosaic</a>	makeKymoMosaic creates a mosaic kymograph of multiple cells.</li><li><a href="trackOptiView.html" class="code" title="function trackOptiView(dirname,file_filter,err_flag)">trackOptiView</a>	trackOptiView provides visulization of the segmented data.</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [imFix,roffset] = fixIm(im, ss)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [Kymo,ll1,f1mm,f2mm] = makeKymographC( data, disp_flag, CONST );</a>
0002 <span class="comment">% makeKymographC creates a kymograph for given cell.</span>
0003 <span class="comment">% A kymograph shows the fluorescence of the cell along the long axis</span>
0004 <span class="comment">% of the cell, with time.</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% INPUT :</span>
0007 <span class="comment">%       data : cell data file</span>
0008 <span class="comment">%       disp_flag : 1 to display image, 0 to not display image</span>
0009 <span class="comment">%       CONST : segmentation parameters</span>
0010 <span class="comment">% OUTPUT :</span>
0011 <span class="comment">%       Kymo: Kymo has images at .r .g and .b fields. The combination of</span>
0012 <span class="comment">%       which produces the kymgraph.</span>
0013 <span class="comment">%       ll1:  ? does not seem to be set anywhere</span>
0014 <span class="comment">%       f1mm: is the green channel kymogrpah</span>
0015 <span class="comment">%       f2mm: is the red channel kymograph</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% Copyright (C) 2016 Wiggins Lab</span>
0018 <span class="comment">% University of Washington, 2016</span>
0019 <span class="comment">% This file is part of SuperSeggerOpti.</span>
0020 
0021 
0022 <span class="keyword">if</span> ~isfield(CONST.view, <span class="string">'falseColorFlag'</span> )
0023     CONST.view.falseColorFlag = false;
0024 <span class="keyword">end</span>
0025 
0026 <span class="comment">%figure(1);</span>
0027 <span class="keyword">persistent</span> colormap_;
0028 <span class="keyword">if</span> isempty( colormap_ )
0029     colormap_ = colormap( <span class="string">'jet'</span> );
0030     <span class="comment">%colormap_ = colormap( 'hsv' );</span>
0031 <span class="keyword">end</span>
0032 
0033 <span class="keyword">if</span> nargin &lt; 2
0034     disp_flag = 0;
0035 <span class="keyword">end</span>
0036 
0037 num_im = numel(data.CellA);
0038 
0039 ss = [0,0];
0040 ll = [0,0];
0041 
0042 <span class="keyword">for</span> ii = 1:num_im
0043     ss_tmp = size(data.CellA{ii}.phase);
0044     
0045     ss(1) = max([ss(1),ss_tmp(1)]);
0046     ss(2) = max([ss(2),ss_tmp(2)]);
0047     
0048     ll_tmp = data.CellA{ii}.length;
0049     
0050     ll(1) = max([ll(1),ll_tmp(1)]);
0051     ll(2) = max([ll(2),ll_tmp(2)]);
0052 <span class="keyword">end</span>
0053 
0054 ss = ss + [5,5];
0055 
0056 [XX,YY] = meshgrid( 1:ss(2), 1:ss(1) );
0057 ll0 = ll;
0058 ll = ceil(ll/2);
0059 
0060 ll1 = [-ll(1):ll(1)];
0061 ll2 = [-ll(2):ll(2)];
0062 
0063 [LL1,LL2] = meshgrid( ll1,ll2 );
0064 
0065 nn = numel( ll1 );
0066 
0067 kymoR = zeros(nn,num_im);
0068 kymoG = zeros(nn,num_im);
0069 kymoB = zeros(nn,num_im);
0070 
0071 e1old = [];
0072 
0073 <span class="keyword">for</span> ii = 1:num_im
0074     mask  = data.CellA{ii}.mask;
0075     
0076     back  = autogain(data.CellA{ii}.phase);
0077     
0078     <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fluor1'</span>)
0079         fluor1  = data.CellA{ii}.fluor1;
0080         
0081         <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fl1'</span> ) &amp;&amp; <span class="keyword">...</span>
0082                 isfield( data.CellA{ii}.fl1, <span class="string">'bg'</span> )
0083             fluor1 = fluor1 - data.CellA{ii}.fl1.bg;
0084             fluor1(fluor1&lt;0) = 0;
0085         <span class="keyword">else</span>
0086             fluor1 = fluor1 - mean( fluor1(mask));
0087             fluor1(fluor1&lt;0) = 0;
0088         <span class="keyword">end</span>
0089     <span class="keyword">else</span>
0090         fluor1 = 0*data.CellA{ii}.mask;
0091     <span class="keyword">end</span>
0092     
0093     <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fluor2'</span>)
0094         fluor2 = data.CellA{ii}.fluor2;
0095         
0096         <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fl12'</span> ) &amp;&amp; <span class="keyword">...</span>
0097                 isfield( data.CellA{ii}.fl2, <span class="string">'bg'</span> )
0098             fluor2 = fluor2 - data.CellA{ii}.fl2.bg;
0099             fluor2(fluor1&lt;0) = 0;
0100         <span class="keyword">else</span>
0101             fluor2 = fluor2 - mean( fluor2(mask));
0102             fluor2(fluor2&lt;0) = 0;
0103             
0104         <span class="keyword">end</span>
0105     <span class="keyword">else</span>
0106         fluor2 = 0*data.CellA{ii}.mask;
0107     <span class="keyword">end</span>
0108     
0109     sq = [1 1 1; 1 1 1; 1 1 1];
0110     mask_ = imdilate(data.CellA{ii}.mask,sq);
0111     mask  = data.CellA{ii}.mask;
0112     outline= mask_-mask;
0113     
0114     maski = autogain(outline);
0115     
0116     <span class="comment">% Make all the images the same sizes</span>
0117     [rChan,roffset] = (<a href="#_sub1" class="code" title="subfunction [imFix,roffset] = fixIm(im, ss)">fixIm</a>(double(fluor2).*double(mask),ss));
0118     [gChan,roffset] = (<a href="#_sub1" class="code" title="subfunction [imFix,roffset] = fixIm(im, ss)">fixIm</a>(double(fluor1).*double(mask),ss));
0119     [bChan,roffset] = <a href="#_sub1" class="code" title="subfunction [imFix,roffset] = fixIm(im, ss)">fixIm</a>(mask,ss);
0120     
0121     ro = data.CellA{ii}.r_offset;
0122     r = data.CellA{ii}.r;
0123     
0124     e1 = data.CellA{ii}.coord.e1;
0125     e2 = data.CellA{ii}.coord.e2;
0126     
0127     LL1x =  LL1*e1(1)+LL2*e2(1)+r(1)-ro(1)+1+roffset(1);
0128     LL2y =  LL1*e1(2)+LL2*e2(2)+r(2)-ro(2)+1+roffset(2);
0129     
0130     rChanp = (interp2(XX,YY,double(rChan),LL1x,LL2y));
0131     gChanp = (interp2(XX,YY,double(gChan),LL1x,LL2y));
0132     bChanp = (interp2(XX,YY,double(bChan),LL1x,LL2y));
0133     
0134     rChanps = sum( double(rChanp) );
0135     gChanps = sum( double(gChanp) );
0136     bChanps = sum( double(bChanp) );
0137     
0138     kymoR(:,ii) = rChanps';
0139     kymoG(:,ii) = gChanps';
0140     kymoB(:,ii) = bChanps';
0141 <span class="keyword">end</span>
0142 
0143 Kymo = [];
0144 
0145 <span class="keyword">if</span> ~isfield(data.CellA{1}, <span class="string">'pole'</span>);
0146     data.CellA{1}.pole.op_ori = 1;
0147 <span class="keyword">end</span>
0148 
0149 
0150 <span class="keyword">if</span> data.CellA{1}.pole.op_ori &lt; 0
0151     Kymo.g = kymoG(end:-1:1,:);
0152     Kymo.b = kymoB(end:-1:1,:);
0153     Kymo.b(isnan(Kymo.b)) = 0;
0154     Kymo.r = kymoR(end:-1:1,:);
0155 <span class="keyword">else</span>
0156     Kymo.g = kymoG;
0157     Kymo.b = kymoB;
0158     Kymo.b(isnan(Kymo.b)) = 0;
0159     Kymo.r = kymoR;
0160     
0161 <span class="keyword">end</span>
0162 
0163 f1mm(1) = min( Kymo.g(logical(Kymo.b)));
0164 f1mm(2) = max( Kymo.g(logical(Kymo.b)));
0165 
0166 f2mm(1) = min( Kymo.r(logical(Kymo.b)));
0167 f2mm(2) = max( Kymo.r(logical(Kymo.b)));
0168 
0169 <span class="keyword">if</span> disp_flag
0170     
0171     <span class="keyword">if</span> CONST.view.falseColorFlag
0172         clf;
0173         
0174         backer3 = double(cat(3, Kymo.b, Kymo.b, Kymo.b)&gt;1);
0175         f1mm(1) = min( Kymo.g(logical(Kymo.b)));
0176         f1mm(2) = max( Kymo.g(logical(Kymo.b)));
0177         
0178         f2mm(1) = min( Kymo.r(logical(Kymo.b)));
0179         f2mm(2) = max( Kymo.r(logical(Kymo.b)));
0180                
0181         im = <a href="doColorMap.html" class="code" title="function im_ = doColorMap( im, colormap_ )">doColorMap</a>( ag(Kymo.g,f1mm(1), f1mm(2)), colormap_ );
0182         
0183         imagesc( im.*backer3+.6*(1-backer3) );
0184         
0185     <span class="keyword">else</span>
0186         
0187         clf;      
0188         backer = autogain(Kymo.b);
0189         backer = 0.3*(max(backer(:))-backer);
0190         f1mm(1) = min( Kymo.g(logical(Kymo.b)));
0191         f1mm(2) = max( Kymo.g(logical(Kymo.b)));
0192         
0193         f2mm(1) = min( Kymo.r(logical(Kymo.b)));
0194         f2mm(2) = max( Kymo.r(logical(Kymo.b)));
0195         
0196         imagesc( cat(3, autogain(Kymo.r )+backer, <span class="keyword">...</span>
0197             autogain(Kymo.g)+backer,<span class="keyword">...</span>
0198             backer ));
0199     <span class="keyword">end</span>
0200 <span class="keyword">end</span>
0201 
0202 <span class="keyword">end</span>
0203 
0204 <a name="_sub1" href="#_subfunctions" class="code">function [imFix,roffset] = fixIm(im, ss)</a>
0205 
0206 ssOld = size(im);
0207 imFix = zeros(ss);
0208 
0209 offset = floor((ss-ssOld)/2)-[1,1];
0210 <span class="keyword">if</span> offset(1)&lt;0
0211     offset(1) = offset(1) + 1;
0212 <span class="keyword">end</span>
0213 <span class="keyword">if</span> offset(2)&lt;0
0214     offset(2) = offset(2) + 1;
0215 <span class="keyword">end</span>
0216 
0217 <span class="keyword">try</span>
0218     imFix(offset(1)+(1:ssOld(1)),offset(2)+(1:ssOld(2))) = im;
0219 <span class="keyword">catch</span>
0220     <span class="string">''</span>;
0221 <span class="keyword">end</span>
0222 roffset = offset(2:-1:1);
0223 imFix = imFix;
0224 <span class="keyword">end</span>
0225 
0226</pre></div>
<hr><address>Generated on Tue 23-Feb-2016 16:32:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>