<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of makeFrameMosaic</title>
  <meta name="keywords" content="makeFrameMosaic">
  <meta name="description" content="makeFrameMosaic: Creates a tower for a single cell.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerRelease</a> &gt; <a href="index.html">viz</a> &gt; makeFrameMosaic.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerRelease/viz&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>makeFrameMosaic
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>makeFrameMosaic: Creates a tower for a single cell.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [im] = makeFrameMosaic( data, CONST, xdim, disp_flag, skip ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> makeFrameMosaic: Creates a tower for a single cell.
 The cell is oriented horizontally, and is shown masked, 
 in the fluorescent channel.

 INPUT :
       data : cell file
       CONST : segmentation parameters
       xdim : number of frames in a row in final image
       disp_flag : 1 to display image, 0 to not display iamge
       skip : frames to be skipped in final iamge
 OUTPUT :
       im : frame mosaic image

 Copyright (C) 2016 Wiggins Lab 
 University of Washington, 2016
 This file is part of SuperSeggerOpti.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="doColorMap.html" class="code" title="function im_ = doColorMap( im, colormap_ )">doColorMap</a>	doColorMap : ?</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="makeFrameStripeMosaic.html" class="code" title="function [imTot] = makeFrameStripeMosaic( dirName, CONST, skip, disp_flag )">makeFrameStripeMosaic</a>	makeFrameStripeMosaic :  Creates a cell tower for all the cells in</li><li><a href="trackOptiView.html" class="code" title="function trackOptiView(dirname,file_filter,err_flag)">trackOptiView</a>	trackOptiView provides visulization of the segmented data.</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [im] = makeFrameMosaic( data, CONST, xdim, disp_flag, skip )</a>
0002 <span class="comment">% makeFrameMosaic: Creates a tower for a single cell.</span>
0003 <span class="comment">% The cell is oriented horizontally, and is shown masked,</span>
0004 <span class="comment">% in the fluorescent channel.</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% INPUT :</span>
0007 <span class="comment">%       data : cell file</span>
0008 <span class="comment">%       CONST : segmentation parameters</span>
0009 <span class="comment">%       xdim : number of frames in a row in final image</span>
0010 <span class="comment">%       disp_flag : 1 to display image, 0 to not display iamge</span>
0011 <span class="comment">%       skip : frames to be skipped in final iamge</span>
0012 <span class="comment">% OUTPUT :</span>
0013 <span class="comment">%       im : frame mosaic image</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Copyright (C) 2016 Wiggins Lab</span>
0016 <span class="comment">% University of Washington, 2016</span>
0017 <span class="comment">% This file is part of SuperSeggerOpti.</span>
0018 
0019 del = 0.0;
0020 
0021 
0022 <span class="keyword">persistent</span> strel1;
0023 <span class="keyword">if</span> isempty( strel1 )
0024     strel1 = strel(<span class="string">'disk'</span>,1);
0025 <span class="keyword">end</span>
0026 
0027 <span class="keyword">persistent</span> colormap_;
0028 <span class="keyword">if</span> isempty( colormap_ )
0029     colormap_ = jet( 256 );
0030 <span class="keyword">end</span>
0031 
0032 
0033 <span class="keyword">if</span> ~exist(<span class="string">'skip'</span>,<span class="string">'var'</span>) || isempty( skip )
0034     skip = 1;
0035 <span class="keyword">end</span>
0036 
0037 
0038 <span class="keyword">if</span> ~exist(<span class="string">'disp_flag'</span>, <span class="string">'var'</span> ) || isempty( disp_flag )
0039     disp_flag = true;
0040 <span class="keyword">end</span>
0041 
0042 
0043 <span class="keyword">if</span> isfield( CONST, <span class="string">'view'</span> ) &amp;&amp; isfield( CONST.view, <span class="string">'orientFlag'</span> )
0044     orientFlag = CONST.view.orientFlag;
0045 <span class="keyword">else</span>
0046     orientFlag = true;
0047 <span class="keyword">end</span>
0048 
0049 clf;
0050 
0051 TimeStep     = CONST.getLocusTracks.TimeStep;
0052 numframe = numel( data.CellA );
0053 
0054 imCell = cell( 1, numel(data.CellA) );
0055 alpha = zeros(1, numel(data.CellA) );
0056 ssCell = imCell;
0057 xxCell = imCell;
0058 yyCell = imCell;
0059 
0060 max_x = 0;
0061 max_y = 0;
0062 
0063 
0064 <span class="keyword">for</span> ii = 1:numframe
0065     
0066     <span class="keyword">if</span> orientFlag
0067         
0068         <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'pole'</span> ) &amp;&amp; ~isnan( data.CellA{ii}.pole.op_ori ) &amp;&amp; (data.CellA{ii}.pole.op_ori ~= 0)
0069             ssign = sign(data.CellA{ii}.pole.op_ori);
0070         <span class="keyword">else</span>
0071             ssign = 1;
0072         <span class="keyword">end</span>
0073         
0074         
0075         e1 = data.CellA{ii}.coord.e1;
0076         alpha(ii) = 90-180/pi*atan2(e1(1),e1(2)) + 180*double(ssign==1);
0077         
0078         mask = data.CellA{ii}.mask;
0079         mask = logical(imdilate(mask,strel1));
0080         
0081         tmp = imrotate( double(mask), alpha(ii), <span class="string">'bilinear'</span> );
0082         
0083         sstmp = size( tmp );
0084         
0085         ttmp = sum(tmp);
0086         xmin_ = max([1,find(ttmp&gt;0,1,<span class="string">'first'</span>)-1]);
0087         xmax_ = min([sstmp(2),find(ttmp&gt;0,1, <span class="string">'last'</span>)+1]);
0088         
0089         ttmp = sum(tmp');
0090         ymin_ = max([1,find(ttmp&gt;0,1,<span class="string">'first'</span>)-1]);
0091         ymax_ = min([sstmp(1),find(ttmp&gt;0,1, <span class="string">'last'</span>)+1]);
0092         
0093         
0094         yyCell{ii} = ymin_:ymax_;
0095         xxCell{ii} = xmin_:xmax_;
0096         
0097         <span class="keyword">try</span>
0098             imCell{ii} = tmp( ymin_:ymax_, xmin_:xmax_ );
0099         <span class="keyword">catch</span> ME
0100             printError(ME);
0101         <span class="keyword">end</span>
0102         
0103         ss = size( imCell{ii} );
0104         ssCell{ii} = ss;
0105     <span class="keyword">else</span>
0106         ss = size(data.CellA{ii}.mask);
0107         ssCell{ii} = ss;
0108     <span class="keyword">end</span>
0109     
0110     max_x = max( [max_x, ss(2)] );
0111     max_y = max( [max_y, ss(1)] );
0112 <span class="keyword">end</span>
0113 
0114 
0115 
0116 <span class="keyword">if</span> exist( <span class="string">'xdim'</span>, <span class="string">'var'</span>) &amp;&amp; ~isempty( xdim )
0117     nx = xdim;
0118     ny = ceil( numframe/nx/skip );
0119 <span class="keyword">else</span>
0120     nx = ceil( sqrt( numframe*max_y/max_x/skip ) );
0121     ny = ceil( numframe/nx/skip );
0122 <span class="keyword">end</span>
0123 
0124 max_x = max_x+1;
0125 max_y = max_y+1;
0126 
0127 
0128 imdim = [ max_y*ny + 1, max_x*nx + 1 ];
0129 
0130 im = uint8(zeros(imdim(1), imdim(2), 3 ));
0131 
0132 im1_= uint16(zeros(imdim(1), imdim(2)));
0133 im2_= uint16(zeros(imdim(1), imdim(2)));
0134 mask_d = zeros(imdim(1), imdim(2));
0135 
0136 im_list = [];
0137 
0138 f1mm = [];
0139 f2mm = [];
0140 
0141 
0142 <span class="keyword">for</span> ii = 1:skip:numframe
0143     
0144     yy = floor((ii-1)/nx/skip);
0145     xx = (ii-1)/skip-yy*nx;
0146     
0147     ss = ssCell{ii};
0148     
0149     dx = floor((max_x-ss(2))/2);
0150     dy = floor((max_y-ss(1))/2);
0151     
0152     <span class="keyword">if</span> orientFlag
0153         mask = imCell{ii};
0154         mask = (imdilate( mask, strel1 ));
0155     <span class="keyword">else</span>
0156         mask = data.CellA{ii}.mask;
0157         mask = (imdilate( mask, strel1 ));
0158     <span class="keyword">end</span>
0159     
0160     mask_d(1+yy*max_y+(1:ss(1))+dy, 1+xx*max_x+(1:ss(2))+dx) = mask;
0161     
0162     <span class="comment">% fluor1</span>
0163     <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fluor1'</span> )
0164         
0165         <span class="keyword">if</span> orientFlag
0166             fluor1 = imrotate(data.CellA{ii}.fluor1,alpha(ii));
0167             fluor1 = fluor1(yyCell{ii}, xxCell{ii});
0168         <span class="keyword">else</span>
0169             fluor1 = data.CellA{ii}.fluor1;
0170         <span class="keyword">end</span>
0171         
0172         <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fl1'</span> ) &amp;&amp; <span class="keyword">...</span>
0173                 isfield( data.CellA{ii}.fl1, <span class="string">'bg'</span> )
0174             fluor1 = fluor1 - data.CellA{ii}.fl1.bg;
0175             fluor1(fluor1&lt;0) = 0;
0176         <span class="keyword">else</span>
0177             fluor1 = fluor1 - mean(fluor1(:));
0178             fluor1(fluor1&lt;0) = 0;
0179         <span class="keyword">end</span>
0180         
0181         im1_(1+yy*max_y+(1:ss(1))+dy, 1+xx*max_x+(1:ss(2))+dx) = fluor1;
0182           
0183         FLAG1 = true;
0184     <span class="keyword">else</span>
0185         im1_ = 0*mask_;
0186         FLAG1 = false;
0187         f1mm = [0,1];
0188     <span class="keyword">end</span>
0189     
0190     
0191     <span class="comment">% fluor2</span>
0192     flag2 = isfield( data.CellA{ii}, <span class="string">'fluor2'</span> );
0193     <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fluor2'</span> )
0194                 
0195         <span class="keyword">if</span> orientFlag
0196             fluor2 = imrotate(data.CellA{ii}.fluor2,alpha(ii),<span class="string">'bilinear'</span>);
0197             fluor2 = fluor2(yyCell{ii}, xxCell{ii});
0198         <span class="keyword">else</span>
0199             fluor2 = data.CellA{ii}.fluor2
0200         <span class="keyword">end</span>
0201         
0202         <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fl2'</span> ) &amp;&amp; <span class="keyword">...</span>
0203                 isfield( data.CellA{ii}.fl2, <span class="string">'bg'</span> )
0204             fluor2 = fluor2 - data.CellA{ii}.fl2.bg;
0205             fluor2(fluor2&lt;0) = 0;
0206         <span class="keyword">end</span>
0207         
0208         im2_(1+yy*max_y+(1:ss(1))+dy, 1+xx*max_x+(1:ss(2))+dx) = fluor2;
0209         FLAG2 = true;
0210     <span class="keyword">else</span>
0211         im2_ = uint8(0*mask_d);
0212         FLAG2 = false;
0213         f2mm = [0,1];
0214     <span class="keyword">end</span>
0215     
0216     
0217     <span class="keyword">if</span> FLAG2
0218         im_list = [im_list, data.CellA{ii}.fluor1(:)', data.CellA{ii}.fluor2(:)'];
0219     <span class="keyword">elseif</span> FLAG1
0220         im_list = [im_list, data.CellA{ii}.fluor1(:)'];
0221     <span class="keyword">else</span>
0222         im_list = [im_list];
0223     <span class="keyword">end</span>
0224     
0225 <span class="keyword">end</span>
0226 
0227 
0228 <span class="comment">% do ag</span>
0229 <span class="comment">%im1_ = ag(log(double(im1_)),log(double(f1mm(1))),log(double(f1mm(2))));</span>
0230 im1_ = ag(im1_);
0231 
0232 im2_ = ag(im2_);
0233 
0234 
0235 disk1 = strel(<span class="string">'disk'</span>,1);
0236 <span class="comment">%outer = imdilate(mask_, disk1).*double(~mask_);</span>
0237 
0238 <span class="keyword">if</span> isfield(CONST.view, <span class="string">'falseColorFlag'</span>) &amp;&amp; <span class="keyword">...</span>
0239         CONST.view.falseColorFlag <span class="comment">%&amp;&amp; ~flag2</span>
0240     
0241     <span class="keyword">if</span> ~isfield( CONST.view, <span class="string">'background'</span> );
0242                 CONST.view.background = [0,0,0];
0243     <span class="keyword">end</span>
0244     
0245     im    = ag(<a href="doColorMap.html" class="code" title="function im_ = doColorMap( im, colormap_ )">doColorMap</a>( im1_, colormap_ ));
0246     back3 = uint8( cat( 3, double(CONST.view.background(1))*double(1-mask_d),<span class="keyword">...</span>
0247         double(CONST.view.background(2))*double(1-mask_d),<span class="keyword">...</span>
0248         double(CONST.view.background(3))*double(1-mask_d)));
0249     
0250     mask3 = cat( 3, mask_d, mask_d, mask_d );
0251     im = uint8(uint8( double(im).*mask3)+back3);
0252     
0253 <span class="keyword">elseif</span> 0
0254     del = 0.3;
0255     
0256     im_mean = mean( im_list(:) );
0257     
0258     im1_ = uint16( im1_ - im_mean );
0259     im2_ = uint16( im2_ - im_mean );
0260     
0261     mask__ = ~((~mask_).*(~outer));
0262     
0263     im = cat( 3, <span class="keyword">...</span>
0264         del*ag(~mask__)+ag(double(im2_).*(1+2*double(mask__))), <span class="keyword">...</span>
0265         del*ag(~mask__)+ag(double(im1_).*(1+2*double(mask__))), <span class="keyword">...</span>
0266         uint8(del*ag(~mask__)+ag(outer)) );
0267     
0268 <span class="keyword">elseif</span> 0
0269     
0270     del = 0.25;
0271     
0272     im_mean = mean( im_list(:) );
0273     
0274     im1_ = uint16( im1_ - im_mean );
0275     im2_ = uint16( im2_ - im_mean );
0276     
0277     disk1 = strel(<span class="string">'disk'</span>,1);
0278     outer = imdilate(mask_, disk1).*double(~mask_);
0279     
0280     im = cat( 3, <span class="keyword">...</span>
0281         0*(1+2*double(mask_)), <span class="keyword">...</span>
0282         ag(double(im1_).*double(mask_)), <span class="keyword">...</span>
0283         del*ag(mask_) );
0284 <span class="keyword">else</span>
0285     del = 1;
0286     
0287     disk1 = strel(<span class="string">'disk'</span>,1);
0288     <span class="comment">%    outer = imdilate(mask_, disk1).*double(~mask_);</span>
0289     
0290     im = cat( 3, <span class="keyword">...</span>
0291         uint8(double(im2_).*mask_d)+del*ag(1-mask_d), <span class="keyword">...</span>
0292         uint8(double(im1_).*mask_d)+del*ag(1-mask_d), <span class="keyword">...</span>
0293         del*ag(1-mask_d) );
0294     
0295     
0296 <span class="keyword">end</span>
0297 
0298 
0299 
0300 inv_flag = 0;
0301 
0302 
0303 <span class="keyword">if</span> disp_flag
0304     
0305     <span class="keyword">if</span> inv_flag
0306         imshow( 255-im );
0307     <span class="keyword">else</span>
0308         imshow( im );
0309     <span class="keyword">end</span>
0310     
0311     
0312     <span class="keyword">if</span> isfield( CONST.view, <span class="string">'falseColorFlag'</span> ) <span class="keyword">...</span>
0313             &amp;&amp; CONST.view.falseColorFlag
0314         cc = <span class="string">'w'</span>;
0315     <span class="keyword">else</span>
0316         cc = <span class="string">'b'</span>;
0317     <span class="keyword">end</span>
0318     
0319     
0320     
0321     hold on;
0322     
0323     <span class="keyword">for</span> ii = 1:numframe
0324         
0325         yy = floor((ii-1)/nx);
0326         xx = ii-yy*nx-1;
0327         
0328         y = 1+yy*max_y;
0329         x = 1+xx*max_x;
0330         
0331         
0332         <span class="comment">%text( x+2, y+2, num2str((ii-1)*TimeStep),'Color',cc,'FontSize',12,'VerticalAlignment','Top');</span>
0333         <span class="comment">%      rr = data.CellA{ii}.coord.rcm-data.CellA{ii}.r_offset;</span>
0334         <span class="comment">%      dr = data.CellA{ii}.length(1)*data.CellA{ii}.coord.e1;</span>
0335         <span class="comment">%</span>
0336         <span class="comment">%      plot( x+rr(1)+[0,dr(1)], y+rr(2)+[0,dr(2)], 'r.-' );</span>
0337         
0338         
0339     <span class="keyword">end</span>
0340     
0341     
0342     dd = [1,ny*max_y+1];
0343     <span class="keyword">for</span> xx = 1:(nx-1)
0344         plot( 0*dd + 1+xx*max_x, dd,[<span class="string">':'</span>,cc]);
0345     <span class="keyword">end</span>
0346     
0347     dd = [1,nx*max_x+1];
0348     <span class="keyword">for</span> yy = 1:(ny-1)
0349         plot( dd, 0*dd + 1+yy*max_y, [<span class="string">':'</span>,cc]);
0350     <span class="keyword">end</span>
0351 <span class="keyword">end</span>
0352 
0353 <span class="keyword">end</span>
0354 
0355</pre></div>
<hr><address>Generated on Tue 23-Feb-2016 16:32:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>