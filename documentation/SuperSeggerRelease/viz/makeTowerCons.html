<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of makeTowerCons</title>
  <meta name="keywords" content="makeTowerCons">
  <meta name="description" content="makeTowerCons Makes Times-Lapse Tower with normalized time and cell shape">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerRelease</a> &gt; <a href="index.html">viz</a> &gt; makeTowerCons.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerRelease/viz&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>makeTowerCons
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>makeTowerCons Makes Times-Lapse Tower with normalized time and cell shape</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function  imData = makeTowerCons( data, CONST, xdim,disp_flag, skip, mag ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> makeTowerCons Makes Times-Lapse Tower with normalized time and cell shape

 INPUT:
        data : (struct) Cell data to construct the Time-Lapse Tower
       CONST : (struct) Constant variable
        xdim : 
   disp_flag : (flag) flag to tell the code whether to show progress
        skip : (int) skip every skip files when generating the tower 
         mag : (double) rescale image by mag

 OUPUT:
     imData.tower         = imBWCons;
     imData.towerNorm     = imBWConsNorm;
     imData.towerC        = imColorCons;
     imData.towerNormC    = imColorConsNorm;
     imData.towerRaw      = towerIm;
     imData.towerNormRaw  = towerImNorm;
     imData.towerMask     = maskCons;
     imData.fmax          = f1mm;
     imData.imCell        = imCell;
     imData.imCellNorm    = imCellNorm;
     imData.maskCell      = maskCell;
     imData.imCellScale   = imCellS;
     imData.imCellNormScale  = imCellNormS;
     imData.maskCellScale = maskCellS;
     imData.intWeight     = intWeight;
     imData.intWeightS     = intWeightS;

       imColorCons: (im tower) Colorized cropped cons image of a single cell
         imBWCons : (im tower) Grayscale non-crop cons image for a single cell
         maskCons : (im tower) double 0-1 mask of the cell.
             f1mm : [min intensity, max intensity]

           imCell : Grayscale non-crop cons. (Cell array of ims)
         maskCell : double 0-1 mask of the cell. (Cell array of masks)

 Scaled Long Axis Images, Cell Array of time points:
          imCellS : (Scaled) Grayscale non-crop cons. (Cell array of ims)
        maskCellS : (Scaled) double 0-1 mask of the cell. (Cell array of masks)

 Copyright (C) 2016 Wiggins Lab 
 Unviersity of Washington, 2016
 This file is part of SuperSeggerOpti.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="intCellFit.html" class="code" title="function y = intCellFit( x, x1, x2, h )">intCellFit</a>	</li><li><a href="towerMergeImages.html" class="code" title="function [imColor, imBW, towerIm, maskCons, nx, ny, max_x, max_y ] =towerMergeImages( imCell, maskCell, ssCell, xdim, skip, mag, CONST )">towerMergeImages</a>	towerMergeImages</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="makeConsIm.html" class="code" title="function [ imMosaic, imColor, imBW, imInv, kymo, kymoMask, I,kymoMax, kymoMaskMax, imMosaic10, imBWunmasked, imBWmask, hotPix,AA, BB ] = makeConsIm( dirName, CONST, skip, mag, disp_flag )">makeConsIm</a>	makeConsIm : Computes consensus fluorescence localization from cells in a cell files</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function intDoDraw( im, T0, nx, ny, max_x, max_y, TimeStep, CONST )</a></li><li><a href="#_sub2" class="code">function [fluor1, mask_rot, alpha, ss, xx, yy] = intDoCellOri( celld, W0, mag )</a></li><li><a href="#_sub3" class="code">function [X] = intDoFit( x, ysum )</a></li><li><a href="#_sub4" class="code">function err = intDoFitInt( X )</a></li><li><a href="#_sub5" class="code">function [imCell__, maskCell__, ssCell__, xxCell__, yyCell__, imCellS,</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function  imData = makeTowerCons( data, CONST, xdim, </a><span class="keyword">...</span>
0002     disp_flag, skip, mag )
0003 <span class="comment">% makeTowerCons Makes Times-Lapse Tower with normalized time and cell shape</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% INPUT:</span>
0006 <span class="comment">%        data : (struct) Cell data to construct the Time-Lapse Tower</span>
0007 <span class="comment">%       CONST : (struct) Constant variable</span>
0008 <span class="comment">%        xdim :</span>
0009 <span class="comment">%   disp_flag : (flag) flag to tell the code whether to show progress</span>
0010 <span class="comment">%        skip : (int) skip every skip files when generating the tower</span>
0011 <span class="comment">%         mag : (double) rescale image by mag</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% OUPUT:</span>
0014 <span class="comment">%     imData.tower         = imBWCons;</span>
0015 <span class="comment">%     imData.towerNorm     = imBWConsNorm;</span>
0016 <span class="comment">%     imData.towerC        = imColorCons;</span>
0017 <span class="comment">%     imData.towerNormC    = imColorConsNorm;</span>
0018 <span class="comment">%     imData.towerRaw      = towerIm;</span>
0019 <span class="comment">%     imData.towerNormRaw  = towerImNorm;</span>
0020 <span class="comment">%     imData.towerMask     = maskCons;</span>
0021 <span class="comment">%     imData.fmax          = f1mm;</span>
0022 <span class="comment">%     imData.imCell        = imCell;</span>
0023 <span class="comment">%     imData.imCellNorm    = imCellNorm;</span>
0024 <span class="comment">%     imData.maskCell      = maskCell;</span>
0025 <span class="comment">%     imData.imCellScale   = imCellS;</span>
0026 <span class="comment">%     imData.imCellNormScale  = imCellNormS;</span>
0027 <span class="comment">%     imData.maskCellScale = maskCellS;</span>
0028 <span class="comment">%     imData.intWeight     = intWeight;</span>
0029 <span class="comment">%     imData.intWeightS     = intWeightS;</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%       imColorCons: (im tower) Colorized cropped cons image of a single cell</span>
0032 <span class="comment">%         imBWCons : (im tower) Grayscale non-crop cons image for a single cell</span>
0033 <span class="comment">%         maskCons : (im tower) double 0-1 mask of the cell.</span>
0034 <span class="comment">%             f1mm : [min intensity, max intensity]</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%           imCell : Grayscale non-crop cons. (Cell array of ims)</span>
0037 <span class="comment">%         maskCell : double 0-1 mask of the cell. (Cell array of masks)</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% Scaled Long Axis Images, Cell Array of time points:</span>
0040 <span class="comment">%          imCellS : (Scaled) Grayscale non-crop cons. (Cell array of ims)</span>
0041 <span class="comment">%        maskCellS : (Scaled) double 0-1 mask of the cell. (Cell array of masks)</span>
0042 <span class="comment">%</span>
0043 <span class="comment">% Copyright (C) 2016 Wiggins Lab</span>
0044 <span class="comment">% Unviersity of Washington, 2016</span>
0045 <span class="comment">% This file is part of SuperSeggerOpti.</span>
0046 
0047 del = 0.0;
0048 
0049 
0050 <span class="comment">% set the color map here to generate the color images</span>
0051 <span class="keyword">persistent</span> colormap_;
0052 <span class="keyword">if</span> isempty( colormap_ )
0053     colormap_ = colormap( <span class="string">'jet'</span> );
0054     <span class="comment">%colormap_ = colormap( 'hsv' );</span>
0055 <span class="keyword">end</span>
0056 
0057 
0058 <span class="comment">% fill unset input arguments</span>
0059 <span class="keyword">if</span> ~exist(<span class="string">'skip'</span>,<span class="string">'var'</span>) || isempty( skip )
0060     skip = 1;
0061 <span class="keyword">end</span>
0062 
0063 <span class="keyword">if</span> ~exist(<span class="string">'disp_flag'</span>, <span class="string">'var'</span> ) || isempty( disp_flag )
0064     disp_flag = true;
0065 <span class="keyword">end</span>
0066 
0067 <span class="keyword">if</span> ~exist( <span class="string">'xdim'</span>, <span class="string">'var'</span> ) || isempty( xdim )
0068     <span class="comment">% do something to set xdim</span>
0069 <span class="keyword">end</span>
0070 
0071 <span class="keyword">if</span> isfield( CONST, <span class="string">'view'</span> ) &amp;&amp; isfield( CONST.view, <span class="string">'orientFlag'</span> )
0072     orientFlag = CONST.view.orientFlag;
0073 <span class="keyword">else</span>
0074     orientFlag = true;
0075 <span class="keyword">end</span>
0076 
0077 
0078 <span class="comment">% get the TimeStep variable for plotting</span>
0079 TimeStep     = CONST.getLocusTracks.TimeStep;
0080 
0081 <span class="comment">% get the number of frames</span>
0082 numframe = numel( data.CellA );
0083 
0084 <span class="comment">% init variables</span>
0085 imCell = cell( 1, numel(data.CellA) );
0086 alpha  = zeros(1, numel(data.CellA) );
0087 ssCell = imCell;
0088 xxCell = imCell;
0089 yyCell = imCell;
0090 
0091 
0092 <span class="comment">% set the consensus lengths</span>
0093 
0094 
0095 <span class="comment">% L0 is the length of the cell in the first frame</span>
0096 L0 = 26*mag;
0097 
0098 <span class="comment">% W0 is the width of the cells</span>
0099 W0 =  9*mag;
0100 
0101 <span class="comment">% T0 is the number of frames in the consensus, 8 is typical</span>
0102 T0 =  8;
0103 
0104 <span class="comment">% init the max and min fluor values to empty.</span>
0105 f1mm = [];
0106 
0107 <span class="comment">% straighten and align the cells, frame by frame</span>
0108 <span class="keyword">for</span> ii = 1:numframe
0109     
0110     <span class="comment">% intDoCellOri: (i) rotate the image, (ii) adjust cell width to W0</span>
0111     [imCell{ii}, maskCell{ii}, alpha(ii), ssCell{ii}, xxCell{ii}, yyCell{ii}] = <span class="keyword">...</span>
0112         <a href="#_sub2" class="code" title="subfunction [fluor1, mask_rot, alpha, ss, xx, yy] = intDoCellOri( celld, W0, mag )">intDoCellOri</a>( data.CellA{ii}, W0, mag );
0113        
0114     <span class="comment">% set the max and min fluor values</span>
0115     <span class="keyword">if</span> isempty(f1mm)
0116         <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fluor1mm'</span> )
0117             f1mm = data.CellA{ii}.fluor1mm;
0118         <span class="keyword">else</span>
0119             f1mm = [ min(data.CellA{ii}.fluor1(:)), max(data.CellA{ii}.fluor1(:))];
0120         <span class="keyword">end</span>
0121     <span class="keyword">else</span>
0122         <span class="keyword">if</span> isfield( data.CellA{ii}, <span class="string">'fluor1mm'</span> )
0123             f1mm = [ min([data.CellA{ii}.fluor1mm(1),f1mm(1)]), max([data.CellA{ii}.fluor1mm(2),f1mm(2)]) ];
0124         <span class="keyword">else</span>
0125             f1mm = [ min([f1mm(1),min(data.CellA{ii}.fluor1(:))]), max([f1mm(2),max(data.CellA{ii}.fluor1(:))])];
0126         <span class="keyword">end</span>
0127     <span class="keyword">end</span>
0128 <span class="keyword">end</span>
0129 
0130 
0131 <span class="comment">% rescale the time steps so that they have dimensions L0, W0, and T0</span>
0132 [imCell, maskCell, ssCell, xxCell, yyCell, imCellS, maskCellS, <span class="keyword">...</span>
0133     intWeight, imCellNorm, imCellNormS, intWeightS] = <span class="keyword">...</span>
0134     intDoRescale( imCell, maskCell, ssCell, xxCell, yyCell, L0, W0, T0 );
0135 
0136 <span class="comment">% Merge the images from the arrays into a single image</span>
0137 [ imColorCons, imBWCons, towerIm, maskCons, nx, ny, max_x, max_y ] = <span class="keyword">...</span>
0138     <a href="towerMergeImages.html" class="code" title="function [imColor, imBW, towerIm, maskCons, nx, ny, max_x, max_y ] =towerMergeImages( imCell, maskCell, ssCell, xdim, skip, mag, CONST )">towerMergeImages</a>( imCell, maskCell, ssCell, xdim, skip, mag, CONST );
0139 
0140 <span class="comment">% Merge the images from the arrays into a single image</span>
0141 [ imColorConsNorm, imBWConsNorm, towerImNorm, maskCons, nx, ny, max_x, max_y ] = <span class="keyword">...</span>
0142     <a href="towerMergeImages.html" class="code" title="function [imColor, imBW, towerIm, maskCons, nx, ny, max_x, max_y ] =towerMergeImages( imCell, maskCell, ssCell, xdim, skip, mag, CONST )">towerMergeImages</a>( imCellNorm, maskCell, ssCell, xdim, skip, mag, CONST );
0143 
0144 <span class="comment">% if the disp flag is true, show the image.</span>
0145 <span class="keyword">if</span> disp_flag
0146     <a href="#_sub1" class="code" title="subfunction intDoDraw( im, T0, nx, ny, max_x, max_y, TimeStep, CONST )">intDoDraw</a>( imColorCons, T0, nx, ny, max_x, max_y, TimeStep, CONST );
0147 <span class="keyword">end</span>
0148 
0149 
0150 imData               = [];
0151 imData.tower         = imBWCons;
0152 imData.towerNorm     = imBWConsNorm;
0153 imData.towerC        = imColorCons;
0154 imData.towerNormC    = imColorConsNorm;
0155 imData.towerRaw      = towerIm;
0156 imData.towerNormRaw  = towerImNorm;
0157 imData.towerMask     = maskCons;
0158 imData.fmax          = f1mm;
0159 imData.imCell        = imCell;
0160 imData.imCellNorm    = imCellNorm;
0161 imData.maskCell      = maskCell;
0162 imData.imCellScale   = imCellS;
0163 imData.imCellNormScale  = imCellNormS;
0164 imData.maskCellScale = maskCellS;
0165 imData.intWeight     = intWeight;
0166 imData.intWeightS     = intWeightS;
0167 
0168 
0169 <span class="keyword">end</span>
0170 
0171 
0172 
0173 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0174 <span class="comment">%</span>
0175 <span class="comment">% intDoDraw</span>
0176 <span class="comment">%</span>
0177 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0178 <a name="_sub1" href="#_subfunctions" class="code">function intDoDraw( im, T0, nx, ny, max_x, max_y, TimeStep, CONST )</a>
0179 
0180 imshow( im );
0181 
0182 
0183 <span class="keyword">if</span> CONST.view.falseColorFlag
0184     cc = <span class="string">'w'</span>;
0185 <span class="keyword">else</span>
0186     cc = <span class="string">'b'</span>;
0187 <span class="keyword">end</span>
0188 
0189 
0190 
0191 hold on;
0192 
0193 <span class="keyword">for</span> ii = 1:T0
0194     
0195     yy = floor((ii-1)/nx);
0196     xx = ii-yy*nx-1;
0197     
0198     y = 1+yy*max_y;
0199     x = 1+xx*max_x;
0200     
0201     
0202     text( x+2, y+2, num2str((ii-1)*TimeStep),<span class="string">'Color'</span>,cc,<span class="string">'FontSize'</span>,12,<span class="string">'VerticalAlignment'</span>,<span class="string">'Top'</span>);
0203     
0204 <span class="keyword">end</span>
0205 
0206 
0207 dd = [1,ny*max_y+1];
0208 <span class="keyword">for</span> xx = 1:(nx-1)
0209     plot( 0*dd + 1+xx*max_x, dd,[<span class="string">':'</span>,cc]);
0210 <span class="keyword">end</span>
0211 
0212 dd = [1,nx*max_x+1];
0213 <span class="keyword">for</span> yy = 1:(ny-1)
0214     plot( dd, 0*dd + 1+yy*max_y, [<span class="string">':'</span>,cc]);
0215 <span class="keyword">end</span>
0216 <span class="keyword">end</span>
0217 
0218 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0219 <span class="comment">%</span>
0220 <span class="comment">% do cell orientation</span>
0221 <span class="comment">%</span>
0222 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0223 <a name="_sub2" href="#_subfunctions" class="code">function [fluor1, mask_rot, alpha, ss, xx, yy] = intDoCellOri( celld, W0, mag )</a>
0224 
0225 <span class="keyword">persistent</span> strel1;
0226 <span class="keyword">if</span> isempty( strel1 )
0227     strel1 = strel(<span class="string">'square'</span>,3);
0228 <span class="keyword">end</span>
0229 
0230 
0231 <span class="keyword">if</span> isfield( celld, <span class="string">'pole'</span> ) &amp;&amp; ~isnan( celld.pole.op_ori ) &amp;&amp; (celld.pole.op_ori ~= 0)
0232     ssign = sign(celld.pole.op_ori);
0233 <span class="keyword">else</span>
0234     ssign = 1;
0235 <span class="keyword">end</span>
0236 
0237 <span class="comment">%ssign</span>
0238 
0239 e1 = celld.coord.e1;
0240 alpha = 90-180/pi*atan2(e1(1),e1(2)) + 180*double(ssign==1);
0241 
0242 mask = celld.mask;
0243 
0244 mask     = imrotate(       (mask),         alpha, <span class="string">'bilinear'</span> );
0245 mask = logical(imdilate(mask,strel1));
0246 
0247 <span class="keyword">if</span> isfield( celld, <span class="string">'fl1'</span>) &amp;&amp; isfield( celld.fl1, <span class="string">'bg'</span> ) &amp;&amp; ~isnan( celld.fl1.bg)
0248     bg_fluor =  double(celld.fl1.bg);
0249 <span class="keyword">else</span>
0250     bg_fluor = 0;
0251 <span class="keyword">end</span>
0252 
0253 fluor1   = imrotate( double(celld.fluor1)-bg_fluor, alpha, <span class="string">'bilinear'</span>);
0254 
0255 mask_rot = imresize( mask,   mag );
0256 
0257 
0258 
0259 fluor1   = imresize( fluor1, mag );
0260 
0261 sstmp = size( mask_rot );
0262 
0263 x = 1:sstmp(2);
0264 y = 1:sstmp(1);
0265 
0266 x2 = 0.5*(x(1)+x(end));
0267 y2 = 0.5*(y(1)+y(end));
0268 
0269 [X,Y] = meshgrid( x, y );
0270 
0271 xsum  = sum(mask_rot);
0272 xsumy = sum(mask_rot.*Y)./xsum;
0273 
0274 <span class="comment">%yshift = xsumy - y2;</span>
0275 <span class="comment">%yshift(isnan(yshift)) = 0;</span>
0276 
0277 ind = isnan(xsumy);
0278 xsumy(ind) = y2;
0279 
0280 mask_rot_ = mask_rot;
0281 fluor1_   = fluor1;
0282 <span class="comment">%for ii = x</span>
0283 <span class="comment">%    mask_rot_(:,ii) = interp1( y, mask_rot(:,ii), yshift(ii) + y,'linear','extrap' );</span>
0284 <span class="comment">%    fluor1_(:,ii)   = interp1( y, fluor1(:,ii),   yshift(ii) + y,'linear','extrap' );</span>
0285 <span class="comment">%end</span>
0286 
0287 XXX = <a href="#_sub3" class="code" title="subfunction [X] = intDoFit( x, ysum )">intDoFit</a>( x, xsum );
0288 
0289 RADIUS = W0/2;
0290 xsumt = <a href="intCellFit.html" class="code" title="function y = intCellFit( x, x1, x2, h )">intCellFit</a>( x, XXX(1), XXX(2), RADIUS );
0291 
0292 <span class="keyword">for</span> ii = x
0293     <span class="keyword">if</span> (xsumt(ii)&gt;0) &amp;&amp; (xsum(ii)&gt;0)
0294         dy1 = (y - xsumy(ii))*xsumt(ii)/xsum(ii);
0295         dy2 = (y - y2);
0296         
0297         mask_rot_(:,ii) = interp1( dy1, mask_rot(:,ii), dy2,<span class="string">'linear'</span>,<span class="string">'extrap'</span> );
0298         fluor1_(:,ii)   = interp1( dy1, fluor1(:,ii),   dy2,<span class="string">'linear'</span>,<span class="string">'extrap'</span> );
0299     <span class="keyword">else</span>
0300         mask_rot_(:,ii) = 0*mask_rot(:,ii);
0301         fluor1_(:,ii)   = fluor1(:,ii);
0302     <span class="keyword">end</span>
0303 <span class="keyword">end</span>
0304 
0305 
0306 xsum  = sum(mask_rot_);
0307 xmin_ = max([1,find(xsum&gt;0,1,<span class="string">'first'</span>)-1]);
0308 xmax_ = min([sstmp(2),find(xsum&gt;0,1, <span class="string">'last'</span>)+1]);
0309 
0310 ysum  = sum(mask_rot_');
0311 ymin_ = max([1,find(ysum&gt;0,1,<span class="string">'first'</span>)-1]);
0312 ymax_ = min([sstmp(1),find(ysum&gt;0,1, <span class="string">'last'</span>)+1]);
0313 
0314 
0315 yy = ymin_:ymax_;
0316 xx = xmin_:xmax_;
0317 
0318 
0319 mask_rot = mask_rot_( ymin_:ymax_, xmin_:xmax_ );
0320 fluor1   = fluor1_(yy, xx);
0321 
0322 ss = size( mask_rot );
0323 
0324 <span class="keyword">end</span>
0325 
0326 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0327 <span class="comment">%</span>
0328 <span class="comment">% do the fit to the theoretical shape of the cell</span>
0329 <span class="comment">%</span>
0330 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0331 <a name="_sub3" href="#_subfunctions" class="code">function [X] = intDoFit( x, ysum )</a>
0332 
0333 X(1) = find( ysum, 1, <span class="string">'first'</span>);
0334 X(2) = find( ysum, 1, <span class="string">'last'</span>);
0335 X(3) = max( ysum );
0336 
0337 X = fminsearch( @<a href="#_sub4" class="code" title="subfunction err = intDoFitInt( X )">intDoFitInt</a>, X );
0338 
0339     <a name="_sub4" href="#_subfunctions" class="code">function err = intDoFitInt( X )</a>
0340         y   = <a href="intCellFit.html" class="code" title="function y = intCellFit( x, x1, x2, h )">intCellFit</a>( x, X(1), X(2), X(3) );
0341         
0342         err = sum( (ysum-y).^2 );
0343     <span class="keyword">end</span>
0344 
0345 
0346 <span class="keyword">if</span> 0
0347     clf;
0348     plot( x, ysum, <span class="string">'y.-'</span>);
0349     hold on;
0350     plot( x, <a href="intCellFit.html" class="code" title="function y = intCellFit( x, x1, x2, h )">intCellFit</a>( x, X(1), X(2), X(3) ), <span class="string">'r.-'</span>);
0351     pause;
0352 <span class="keyword">end</span>
0353 <span class="keyword">end</span>
0354 
0355 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0356 <span class="comment">%</span>
0357 <span class="comment">% do rescale of cell in both space and time and fixes the normalization</span>
0358 <span class="comment">% over time of the tower.</span>
0359 <span class="comment">%</span>
0360 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0361 <a name="_sub5" href="#_subfunctions" class="code">function [imCell__, maskCell__, ssCell__, xxCell__, yyCell__, imCellS, </a><span class="keyword">...</span>
0362     maskCellS, intWeight, imCellNorm__, imCellNormS, intWeightS ] = <span class="keyword">...</span>
0363     intDoRescale( imCell, maskCell, ssCell, xxCell, yyCell, L0, W0, T0 )
0364 
0365 nt = numel( imCell );
0366 tt = (0:(T0-1))/(T0-1);
0367 
0368 
0369 <span class="comment">% (i) Renormalize the length of the cell to make it L = L0*(1+t/T)</span>
0370 <span class="keyword">for</span> ii = 1:nt
0371     tii = (ii-1)/(nt-1);
0372     Lii = L0*(1+tii);
0373     
0374     ss = size( imCell{ii} );
0375     
0376     x = 1:ss(2);
0377     y = 1:ss(1);
0378     
0379     [ X, Y ] = meshgrid( x, y );
0380     
0381     xsum  = sum(maskCell{ii});
0382     
0383     xcom  = sum(maskCell{ii}(:).*X(:))/sum(maskCell{ii}(:));
0384     ycom  = sum(maskCell{ii}(:).*Y(:))/sum(maskCell{ii}(:));
0385     
0386     xi = (1:(2*L0+4))-(2*L0+4-1)/2;
0387     yi = (1:(W0+4))-(W0+4-1)/2;
0388     
0389     [Xi,Yi] = meshgrid( xi, yi );
0390     
0391     xmin_ = max([1,find(xsum&gt;1,1,<span class="string">'first'</span>)-1]);
0392     xmax_ = min([ssCell{ii}(2),find(xsum&gt;1,1, <span class="string">'last'</span>)+1]);
0393     dx = xmax_ - xmin_ + 1;
0394     
0395     imCell_{ii}   = interp2( (X-xcom)/dx*2*L0, Y-ycom,   imCell{ii}, Xi-1, Yi-1);
0396     maskCell_{ii} = interp2( (X-xcom)/dx*2*L0, Y-ycom, maskCell{ii}, Xi-1, Yi-1);
0397     
0398     
0399     <span class="comment">% imshow( maskCell_{ii}, [] );</span>
0400     <span class="comment">% 'hi'</span>
0401     
0402     
0403 <span class="keyword">end</span>
0404 
0405 <span class="comment">% (ii) Renormalize the length of the cell cycle to be length T0.</span>
0406 <span class="keyword">for</span> ii = 1:T0
0407     
0408     jj = (ii-1)/(T0-1)*(nt-1)+1;
0409     
0410     jjm = floor(jj);
0411     jjp = jjm + 1;
0412     djj = jj-jjm;
0413     
0414     <span class="keyword">if</span> ii == 1
0415         imCell__{ii} = imCell_{ii};
0416         maskCell__{ii} = maskCell_{ii};
0417     <span class="keyword">elseif</span> ii == T0
0418         imCell__{ii} = imCell_{end};
0419         maskCell__{ii} = maskCell_{end};
0420     <span class="keyword">else</span>
0421         imCell__{ii} = (1-djj)*imCell_{jjm} + djj*imCell_{jjp};
0422         maskCell__{ii} = (1-djj)*maskCell_{jjm} + djj*maskCell_{jjp};
0423     <span class="keyword">end</span>
0424     
0425 <span class="keyword">end</span>
0426 
0427 <span class="comment">% save the scaled versions</span>
0428 imCellS   = imCell__;
0429 imCellNormS   = imCell__;
0430 
0431 maskCellS = maskCell__;
0432 intWeight = zeros(1,T0);
0433 intWeightS = zeros(1,T0);
0434 
0435 imCellNorm__ =  imCell__;
0436 
0437 <span class="comment">% rescale the long axis dimension to scale uniformly</span>
0438 <span class="keyword">for</span> ii = 1:T0
0439     tii = (ii-1)/(T0-1);
0440     Lii = L0*(1+tii);
0441     
0442     xi = (1:(2*L0+4))-(2*L0+4-1)/2;
0443     yi = (1:(W0+4))-(W0+4-1)/2;
0444     
0445     [Xi,Yi] = meshgrid( xi, yi );
0446     
0447     <span class="comment">%     xmin_ = max([1,find(xsum&gt;1,1,'first')-1]);</span>
0448     <span class="comment">%     try</span>
0449     <span class="comment">%     xmax_ = min([ssCell{ii}(2),find(xsum&gt;1,1, 'last')+1]);</span>
0450     <span class="comment">%     catch</span>
0451     <span class="comment">%        'hi'</span>
0452     <span class="comment">%     end</span>
0453     <span class="comment">%     dx = xmax_ - xmin_ + 1;</span>
0454     
0455     imCell__{ii}   = interp2(  (Xi-1), Yi-1,   imCell__{ii}, (Xi-1)*(2*L0)/Lii, Yi-1);
0456     maskCell__{ii} = interp2(  (Xi-1), Yi-1, maskCell__{ii}, (Xi-1)*(2*L0)/Lii, Yi-1);
0457     
0458     imCell__{ii}(isnan(imCell__{ii}))     = 0;
0459     maskCell__{ii}(isnan(maskCell__{ii})) = 0;
0460 
0461     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0462     <span class="comment">% normalize fluor so that the mean fluor remains constant over time.</span>
0463        
0464     <span class="comment">% the abs here is a bit of a cheat to nexver allow the sum fluor to</span>
0465     <span class="comment">% diverge. Due to illulimnation non-unifority and real life, sum can be</span>
0466     <span class="comment">% essentially = 0 causing all sorts of problems later.</span>
0467     
0468     sum_ = sum(abs(imCell__{ii}(:)).*maskCell__{ii}(:))/sum(maskCell__{ii}(:));
0469     imCellNorm__{ii} = imCell__{ii}/sum_;
0470     intWeight(ii) = sum_;
0471     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0472     
0473     <span class="comment">% normalize fluor so that the mean fluor remains constant over time.</span>
0474     imCellS{ii}(isnan(imCellS{ii}))      = 0;
0475     maskCellS{ii}(isnan(maskCellS{ii}))  = 0;
0476     
0477     sumS_ = sum(imCellS{ii}(:).*maskCellS{ii}(:))/sum(maskCellS{ii}(:));
0478     imCellNormS{ii} = imCellS{ii}/sumS_;
0479     intWeightS(ii) = sumS_;
0480 
0481     <span class="comment">%imshow( maskCell__{ii}, [] );</span>
0482     
0483     ssCell__{ii} = size( imCell__{ii} );
0484     xxCell__{ii} = 1:ssCell__{ii}(2);
0485     yyCell__{ii} = 1:ssCell__{ii}(1);
0486     
0487 <span class="keyword">end</span>
0488 <span class="comment">%intWeight</span>
0489 
0490 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 23-Feb-2016 16:32:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>