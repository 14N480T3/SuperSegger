<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of regionOpti</title>
  <meta name="keywords" content="regionOpti">
  <meta name="description" content="regionOpti : Segmentaion optimization using region characteristics.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerRelease</a> &gt; <a href="index.html">segmentation</a> &gt; regionOpti.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerRelease/segmentation&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>regionOpti
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>regionOpti : Segmentaion optimization using region characteristics.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [data] = regionOpti( data, dispp, CONST,header) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> regionOpti : Segmentaion optimization using region characteristics.
  Paul Wiggins, 07/24/2010</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="makeRegSize.html" class="code" title="function [L1,L2] = makeRegSize( mask, props )">makeRegSize</a>	makeRegSize : computes the projections lengths after rotating.</li><li><a href="makeRegionSizeProjectionBBint2.html" class="code" title="function [L1,L2] = makeRegionSizeProjectionBBint2( mask, props )">makeRegionSizeProjectionBBint2</a>	makeRegionSizeProjectionBBint2 : THIS IS EXACTLY THE SAME AS makeRegSize,</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="ssoSegFun.html" class="code" title="function [ data, err_flag ] = ssoSegFun( phase, CONST, header, dataname, crop_box )">ssoSegFun</a>	ssoSegFun : starts segmentation of phase image and sets error flags</li><li><a href="ssoSegFunPa.html" class="code" title="function [ data, err_flag ] = ssoSegFunPa( phase, CONST, header, dataname, crop_box )">ssoSegFunPa</a>	ssoSegFunPa : starts segmentation of phase image and sets error flags</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function vect = makeVector( nn, n )</a></li><li><a href="#_sub2" class="code">function vect = systematic( segs_list, data, cell_mask, xx, yy, CONST)</a></li><li><a href="#_sub3" class="code">function vect = simAnnealFast( segs_list, data, cell_mask, xx, yy, CONST, debug_flag)</a></li><li><a href="#_sub4" class="code">function E = initState( vect0 )</a></li><li><a href="#_sub5" class="code">function E = perturbState( nn )</a></li><li><a href="#_sub6" class="code">function debugFig</a></li><li><a href="#_sub7" class="code">function str = makeKey( vect )</a></li><li><a href="#_sub8" class="code">function fixState( )</a></li><li><a href="#_sub9" class="code">function E = calcE(reg_vect,seg_vect,state)</a></li><li><a href="#_sub10" class="code">function    T = tempSchedule(t, CONST, num_segs)</a></li><li><a href="#_sub11" class="code">function ee = FixE( ee )</a></li><li><a href="#_sub12" class="code">function vect = simAnneal( segs_list, data, cell_mask, xx, yy, CONST, debug_flag)</a></li><li><a href="#_sub13" class="code">function E = doE(justDoIt, CONST)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [data] = regionOpti( data, dispp, CONST,header)</a>
0002 <span class="comment">% regionOpti : Segmentaion optimization using region characteristics.</span>
0003 <span class="comment">%  Paul Wiggins, 07/24/2010</span>
0004 
0005 MAX_WIDTH          = CONST.regionOpti.MAX_WIDTH;
0006 MAX_LENGTH         = CONST.regionOpti.MAX_LENGTH;
0007 CutOffScoreHi      = CONST.regionOpti.CutOffScoreHi;
0008 CutOffScoreLo      = CONST.regionOpti.CutOffScoreLo;
0009 MAX_NUM_RESOLVE    = CONST.regionOpti.MAX_NUM_RESOLVE;
0010 MAX_NUM_SYSTEMATIC = CONST.regionOpti.MAX_NUM_SYSTEMATIC;
0011 
0012 DE_norm          = CONST.regionOpti.DE_norm;
0013 
0014 <span class="keyword">if</span> ~exist(<span class="string">'header'</span>)
0015     header = [];
0016 <span class="keyword">end</span>
0017 
0018 <span class="keyword">if</span> nargin &lt; 2 || isempty(<span class="string">'dispp'</span>);
0019     
0020     dispp = 1;
0021     
0022 <span class="keyword">end</span>
0023 
0024 
0025 
0026 <span class="comment">% Turn on and off segs outside the cutoff.</span>
0027 segs_label = data.segs.segs_label;
0028 segs_3n    = data.segs.segs_3n;
0029 segs_bad   = 0*data.segs.segs_3n;
0030 segs_good  = segs_bad;
0031 segs_good_off  = segs_bad;
0032 
0033 ss = size(segs_3n);
0034 
0035 num_segs_ = numel(data.segs.score);
0036 
0037 <span class="comment">% tic</span>
0038 <span class="comment">% for ii = 1:num_segs_</span>
0039 <span class="comment">%     [xx,yy] = getBB(data.segs.props(ii).BoundingBox);</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%     if data.segs.scoreRaw(ii) &gt; CutOffScoreHi</span>
0042 <span class="comment">%         segs_3n(yy,xx)    = segs_3n(yy,xx) + (segs_label(yy,xx)==ii);</span>
0043 <span class="comment">%         segs_label(yy,xx) = segs_label(yy,xx) - ii*(segs_label(yy,xx)==ii);</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%     elseif data.segs.scoreRaw(ii) &lt; CutOffScoreLo</span>
0046 <span class="comment">%         segs_bad(yy,xx)    = segs_bad(yy,xx) + (segs_label(yy,xx)==ii);</span>
0047 <span class="comment">%         segs_label(yy,xx) = segs_label(yy,xx) - ii*(segs_label(yy,xx)==ii);</span>
0048 <span class="comment">%     end</span>
0049 <span class="comment">% end</span>
0050 <span class="comment">% toc</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% tic</span>
0053 above_Hi_ind = find(data.segs.scoreRaw &gt; CutOffScoreHi);
0054 below_Lo_ind = find(data.segs.scoreRaw &lt; CutOffScoreLo);
0055 segs_3n = segs_3n + double(ismember(segs_label, above_Hi_ind));
0056 segs_bad = double(ismember(segs_label, below_Lo_ind));
0057 segs_label(logical(segs_3n+segs_bad)) = 0;
0058 <span class="comment">% toc</span>
0059 
0060 
0061 <span class="comment">%segs_bad = double(segs_bad&gt;0);</span>
0062 <span class="comment">%toc</span>
0063 
0064 <span class="comment">%disp('find shorties');</span>
0065 <span class="comment">%tic</span>
0066 <span class="comment">%----------------------------------------------------------------------</span>
0067 <span class="comment">%</span>
0068 <span class="comment">% Find short regions and add surrounding segments to the stack</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%----------------------------------------------------------------------</span>
0071 
0072 mask_regs = double((data.mask_bg-segs_3n)&gt;0);
0073 regs_label =  (bwlabel( mask_regs, 4 ));
0074 regs_props = regionprops( regs_label, <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span> );
0075 num_regs   = max( regs_label(:));
0076 segs_added = [];
0077 
0078 disp([header, <span class="string">'rO: Got '</span>,num2str(num_regs),<span class="string">' regions.'</span>]);
0079 
0080 
0081 <span class="keyword">for</span> ii = 1:num_regs
0082     
0083     [xx,yy] = getBBpad(regs_props(ii).BoundingBox,ss,2);
0084     
0085     tmp_mask = (regs_label(yy,xx)==ii);
0086     
0087     [L1,L2] = <a href="makeRegionSizeProjectionBBint2.html" class="code" title="function [L1,L2] = makeRegionSizeProjectionBBint2( mask, props )">makeRegionSizeProjectionBBint2</a>( tmp_mask, regs_props(ii) );
0088     
0089     
0090     
0091     debug_flag = 0;
0092     
0093     <span class="keyword">if</span> debug_flag
0094         clf
0095         imshow( cat(3,ag(regs_label==ii),ag(regs_label&gt;0),ag(data.phase)), [])
0096         disp([num2str(L1),<span class="string">', '</span>,num2str(L2)]);
0097         keyboard;
0098     <span class="keyword">end</span>
0099     
0100     
0101     <span class="keyword">if</span> L1 &lt; MAX_LENGTH;
0102         
0103         tmp_mask = imdilate(tmp_mask, strel(<span class="string">'square'</span>,3));
0104         
0105         tmp_added = unique( tmp_mask.*data.segs.segs_label(yy,xx).*segs_3n(yy,xx));
0106         tmp_added = tmp_added(logical(tmp_added));
0107         tmp_added = reshape(tmp_added,1,numel(tmp_added));
0108         segs_added = [segs_added,tmp_added];
0109     <span class="keyword">end</span>
0110     
0111 <span class="keyword">end</span>
0112 
0113 
0114 
0115 
0116 segs_added = unique(segs_added);
0117 
0118 <span class="comment">% segs_3n_old    = segs_3n;</span>
0119 <span class="comment">% segs_label_old = segs_label;</span>
0120 <span class="comment">% if ~isempty( segs_added)</span>
0121 <span class="comment">%     for ii = segs_added</span>
0122 <span class="comment">%</span>
0123 <span class="comment">%         [xx,yy] = getBB(data.segs.props(ii).BoundingBox);</span>
0124 <span class="comment">%</span>
0125 <span class="comment">%         segs_3n(yy,xx) = segs_3n(yy,xx) - double(ii==data.segs.segs_label(yy,xx));</span>
0126 <span class="comment">%         segs_label(yy,xx) = segs_label(yy,xx) + ii*(data.segs.segs_label(yy,xx)==ii);</span>
0127 <span class="comment">%     end</span>
0128 <span class="comment">% end</span>
0129 <span class="comment">% segs_3n_1    = segs_3n;</span>
0130 <span class="comment">% segs_label_1 = segs_label;</span>
0131 <span class="comment">%</span>
0132 <span class="comment">% segs_3n    = segs_3n_old;</span>
0133 <span class="comment">% segs_label = segs_label_old;</span>
0134 <span class="comment">%</span>
0135 
0136 segs_added_ = ismember( data.segs.segs_label, segs_added);
0137 segs_3n(segs_added_) = 0;
0138 segs_label(segs_added_) = data.segs.segs_label(segs_added_);
0139 
0140 
0141 
0142 <span class="comment">%toc</span>
0143 <span class="comment">%---------------------------------------------------------------------</span>
0144 <span class="comment">% as a result of that code, we now have added all the segments above the</span>
0145 <span class="comment">% high cutoff to segs_3n, which is always on and added the segs below the</span>
0146 <span class="comment">% low cutoff to segs_bad, and have removed them from the local copy of</span>
0147 <span class="comment">% segs_label.</span>
0148 
0149 
0150 mask_regs = double((data.mask_bg-segs_3n)&gt;0);
0151 regs_label = (bwlabel( mask_regs, 4 ));
0152 regs_props = regionprops( regs_label, <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span>  );
0153 num_regs   = max( regs_label(:));
0154 
0155 <span class="comment">% mask_regs is the super mask of all boundaries + stuff that has to be on.</span>
0156 <span class="comment">% regs_label labels these regions.</span>
0157 rs_list = cell(1,num_regs);
0158 
0159 <span class="comment">%disp('main loop')</span>
0160 <span class="comment">%tic</span>
0161 
0162 ss = size(data.phase);
0163 
0164 <span class="keyword">for</span> ii = 1:num_regs
0165     
0166     <span class="comment">% if dispp</span>
0167     <span class="comment">%  ii/num_regs</span>
0168     <span class="comment">%end</span>
0169     <span class="comment">%   if ii == 25</span>
0170     
0171     <span class="comment">%      'hi'</span>
0172     <span class="comment">%    end</span>
0173     
0174     [xx,yy] = getBBpad(regs_props(ii).BoundingBox,ss,2);
0175     
0176     cell_mask = (regs_label(yy,xx) == ii);
0177     
0178     
0179     <span class="comment">%imshow( cat(3,autogain(cell_mask), autogain(regs_label(yy,xx)&gt;0),autogain(cell_mask)*0));</span>
0180     
0181     
0182     <span class="comment">% get the names of the remaining segments that are in this region.</span>
0183     segs_list = unique( cell_mask.*segs_label(yy,xx));
0184     
0185     <span class="comment">% get rid of zero and make sure the thing is a row vector.</span>
0186     segs_list = segs_list(logical(segs_list));
0187     segs_list = reshape(segs_list,1,numel(segs_list));
0188     
0189     rs_list{ii} = segs_list;
0190     
0191     <span class="comment">%if ~isempty( segs_list )</span>
0192     
0193     <span class="comment">% If there are too many regions to resolve, turn the highest abs</span>
0194     <span class="comment">% scores on as predicted by seg scores</span>
0195     
0196     
0197     
0198     <span class="comment">% -----------------------------------------------------------------</span>
0199     <span class="comment">%</span>
0200     <span class="comment">% Turn on guys who would help resolve cells that are too wide</span>
0201     <span class="comment">%</span>
0202     <span class="comment">% -----------------------------------------------------------------</span>
0203     
0204     <span class="comment">% First turn everything on in the seg_list and check to make sure that</span>
0205     <span class="comment">% the regions are small enough.</span>
0206     tmp_segs = cell_mask;
0207     
0208     <span class="comment">%for ff = segs_list;</span>
0209     <span class="comment">%    tmp_segs = tmp_segs-(ff==segs_label(yy,xx));</span>
0210     <span class="comment">%end</span>
0211     
0212     tmp_segs = cell_mask-ismember( segs_label(yy,xx),segs_list );
0213     
0214     tmp_segs = double(tmp_segs&gt;0);
0215     tmp_label = (bwlabel( tmp_segs, 4 ));
0216     tmp_props = regionprops( tmp_label, <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span>  );
0217     num_tmp   = max( tmp_label(:));
0218     
0219     segs_added = [];
0220     
0221     <span class="keyword">for</span> ff = 1:num_tmp
0222         
0223         tmp_mask = (tmp_label==ff);
0224         [L1,L2] = <a href="makeRegSize.html" class="code" title="function [L1,L2] = makeRegSize( mask, props )">makeRegSize</a>( tmp_mask, tmp_props(ff) );
0225         
0226         <span class="keyword">if</span> L2 &gt; MAX_WIDTH;
0227             
0228             tmp_added = unique( tmp_mask.*data.segs.segs_label(yy,xx));
0229             tmp_added = tmp_added(logical(tmp_added));
0230             tmp_added = reshape(tmp_added,1,numel(tmp_added));
0231             segs_added = [segs_added,tmp_added];
0232         <span class="keyword">end</span>
0233     <span class="keyword">end</span>
0234     
0235     
0236     <span class="comment">%tmp_segs2 = cell_mask*0;</span>
0237     <span class="comment">%</span>
0238     <span class="comment">%         for ff = segs_added;</span>
0239     <span class="comment">%             tmp_segs2 = tmp_segs2+(ff==data.segs.segs_label(yy,xx));</span>
0240     <span class="comment">%         end</span>
0241     <span class="comment">%</span>
0242     <span class="comment">%         imshow( cat(3,autogain(tmp_segs),autogain(0&lt;data.segs.segs_label(yy,xx)),autogain(tmp_segs2)));</span>
0243     <span class="comment">%         ''</span>
0244     
0245     segs_list = unique([segs_list,segs_added]);
0246     
0247     
0248     
0249     
0250     
0251     <span class="keyword">if</span> isempty(segs_list)
0252         
0253         [vect] = [];
0254         
0255     <span class="keyword">elseif</span> numel(segs_list) &gt; MAX_NUM_RESOLVE
0256         
0257         disp([header, <span class="string">'rO: Too many regions to analyze ('</span>,num2str(numel(segs_list)),<span class="string">').'</span>]);
0258         
0259         [vect] = data.segs.scoreRaw(segs_list)&gt;0;
0260         
0261     <span class="keyword">elseif</span> numel(segs_list) &gt; MAX_NUM_SYSTEMATIC
0262         
0263         disp([header, <span class="string">'rO: Simulated Anneal ('</span>,num2str(numel(segs_list)),<span class="string">').'</span>]);
0264         
0265         debug_flag = 0;
0266         
0267         <span class="keyword">if</span> debug_flag
0268             CONST.regionOpti.Emax          = 1e2;
0269             CONST.regionOpti.fignum        = 2;
0270             CONST.regionOpti.dt            = 25;
0271             CONST.regionOpti.Nt            = 256;
0272             tic;
0273             [vect] = <a href="#_sub3" class="code" title="subfunction vect = simAnnealFast( segs_list, data, cell_mask, xx, yy, CONST, debug_flag)">simAnnealFast</a>( segs_list, data, <span class="keyword">...</span>
0274                 cell_mask, xx, yy, CONST, debug_flag);
0275             toc
0276             
0277             CONST.regionOpti.Emax          = 1e2;
0278             CONST.regionOpti.fignum        = 3;
0279             CONST.regionOpti.dt            = 25;
0280             CONST.regionOpti.Nt            = 256;
0281             tic;
0282             [vect] = <a href="#_sub12" class="code" title="subfunction vect = simAnneal( segs_list, data, cell_mask, xx, yy, CONST, debug_flag)">simAnneal</a>( segs_list, data, <span class="keyword">...</span>
0283                 cell_mask, xx, yy, CONST, debug_flag);
0284             toc
0285             
0286             pause;
0287         <span class="keyword">else</span>
0288             
0289             [vect] = <a href="#_sub3" class="code" title="subfunction vect = simAnnealFast( segs_list, data, cell_mask, xx, yy, CONST, debug_flag)">simAnnealFast</a>( segs_list, data, <span class="keyword">...</span>
0290                 cell_mask, xx, yy, CONST, debug_flag);
0291             
0292             <span class="comment">%            [vect] = simAnneal( segs_list, data, ...</span>
0293             <span class="comment">%                cell_mask, xx, yy, CONST, debug_flag);</span>
0294             <span class="comment">%</span>
0295         <span class="keyword">end</span>
0296         <span class="comment">%disp('Done');</span>
0297     <span class="keyword">else</span>
0298         
0299         [vect] = <a href="#_sub2" class="code" title="subfunction vect = systematic( segs_list, data, cell_mask, xx, yy, CONST)">systematic</a>( segs_list, data, cell_mask, xx, yy, CONST);
0300         
0301     <span class="keyword">end</span>
0302     
0303     num_segs = numel(segs_list);
0304     
0305     <span class="comment">%size(vect)</span>
0306     <span class="comment">%     for kk = 1:num_segs</span>
0307     <span class="comment">%         segs_good(yy,xx)     = segs_good(yy,xx)+vect(kk)*(segs_list(kk)==data.segs.segs_label(yy,xx));</span>
0308     <span class="comment">%         segs_good_off(yy,xx) = segs_good_off(yy,xx)+double(~vect(kk))*(segs_list(kk)==data.segs.segs_label(yy,xx));</span>
0309     <span class="comment">%     end</span>
0310     <span class="comment">%</span>
0311     <span class="keyword">try</span>
0312         segs_good(yy,xx)     = segs_good(yy,xx)     + ismember( data.segs.segs_label(yy,xx), segs_list(logical(vect)));
0313         segs_good_off(yy,xx) = segs_good_off(yy,xx) + ismember( data.segs.segs_label(yy,xx), segs_list(~vect));
0314     <span class="keyword">catch</span>
0315         <span class="string">'hi'</span>
0316     <span class="keyword">end</span>
0317     
0318     <span class="comment">%end</span>
0319 <span class="keyword">end</span>
0320 
0321 data.mask_cell = double((data.mask_bg-segs_3n-segs_good)&gt;0);
0322 <span class="comment">%toc</span>
0323 
0324 <span class="comment">%disp('Cleanup');</span>
0325 <span class="comment">%tic</span>
0326 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0327 <span class="comment">% reset the seg scores incase you want to use this with segsManage</span>
0328 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0329 segs_on_ind = unique((~data.mask_cell).*data.segs.segs_label);
0330 segs_on_ind = segs_on_ind(logical(segs_on_ind));
0331 data.segs.score(segs_on_ind) = 1;
0332 
0333 segs_off_ind = unique((data.mask_cell).*data.segs.segs_label);
0334 segs_off_ind = segs_off_ind(logical(segs_off_ind));
0335 data.segs.score(segs_off_ind) = 0;
0336 
0337 
0338 cell_mask = data.mask_cell;
0339 
0340 data.segs.segs_good   = double(data.segs.segs_label&gt;0).*double(~data.mask_cell);
0341 data.segs.segs_bad   = double(data.segs.segs_label&gt;0).*data.mask_cell;
0342 
0343 <span class="comment">%toc</span>
0344 
0345 <span class="keyword">if</span> dispp
0346     back = double(0.7*ag( data.phase ));
0347     
0348     outline = imdilate( cell_mask, strel( <span class="string">'square'</span>,3) );
0349     outline = ag(outline-cell_mask);
0350     
0351     <span class="comment">%     imshow(cat(3,0.5*autogain(cell_mask)+0.5*autogain(segs_good),...</span>
0352     <span class="comment">%         0.5*autogain(cell_mask)+0.25*autogain(segs_good_off&gt;0),...</span>
0353     <span class="comment">%         0.5*autogain(cell_mask)+.5+autogain((segs_bad-segs_good_off-segs_good)&gt;0)),'InitialMagnification','fit');</span>
0354     <span class="comment">%     drawnow;</span>
0355     
0356     segs_never = ((segs_bad-segs_good_off-segs_good)&gt;0);
0357     segs_tried = ((segs_good_off + segs_good)&gt;0);
0358     
0359     <span class="comment">%     imshow(uint8(cat(3,back + 1.00*double(outline),...</span>
0360     <span class="comment">%         back + 0.3*double(ag(segs_tried)),...</span>
0361     <span class="comment">%         back + 0.2*double(ag(~cell_mask)-outline) + 0.7*double(ag(segs_never)))),'InitialMagnification','fit');</span>
0362     <span class="comment">%</span>
0363     <span class="keyword">try</span>
0364         clf
0365         imshow(uint8(cat(3,back + 1.00*double(outline),<span class="keyword">...</span>
0366             back + 0.3*double(ag(segs_tried)),<span class="keyword">...</span>
0367             back + 0.3*double(ag(segs_tried)).*double(segs_good_off) + 0.2*double(ag(~cell_mask)-outline) + 0.5*double(ag(segs_never)))));
0368     <span class="keyword">catch</span>
0369         <span class="string">''</span>;
0370     <span class="keyword">end</span>
0371     drawnow;
0372     
0373 <span class="keyword">end</span>
0374 <span class="keyword">end</span>
0375 
0376 <span class="comment">% function nn = makeAddress( vect )</span>
0377 <span class="comment">%</span>
0378 <span class="comment">% nn = 0;</span>
0379 <span class="comment">% n = numel(vect);</span>
0380 <span class="comment">%</span>
0381 <span class="comment">% for i=n-1:-1:0;</span>
0382 <span class="comment">%     nn = nn + vect(i+1)*2^i;</span>
0383 <span class="comment">% end</span>
0384 <span class="comment">%</span>
0385 <span class="comment">% end</span>
0386 
0387 <a name="_sub1" href="#_subfunctions" class="code">function vect = makeVector( nn, n )</a>
0388 
0389 vect = zeros(1,n);
0390 <span class="keyword">for</span> i=n-1:-1:0;
0391     
0392     
0393     
0394     vect(i+1) = floor(nn/2^i);
0395     
0396     nn = nn - vect(i+1)*2^i;
0397 <span class="keyword">end</span>
0398 
0399 <span class="keyword">end</span>
0400 
0401 
0402 
0403 <a name="_sub2" href="#_subfunctions" class="code">function vect = systematic( segs_list, data, cell_mask, xx, yy, CONST)</a>
0404 
0405 
0406 debug_flag = 0;
0407 
0408 num_segs = numel(segs_list);
0409 num_comb = 2^num_segs;
0410 
0411 regionScore = zeros( 1, num_comb );
0412 ss = size(data.phase);
0413 
0414 <span class="keyword">for</span> jj = 1:num_comb;
0415     
0416     vect = <a href="#_sub1" class="code" title="subfunction vect = makeVector( nn, n )">makeVector</a>(jj-1,num_segs);
0417     
0418     
0419     <span class="comment">%make mask;</span>
0420     cell_mask_mod = cell_mask;
0421     
0422     <span class="keyword">for</span> kk = 1:num_segs
0423         
0424         cell_mask_mod = cell_mask_mod - vect(kk)*(segs_list(kk)==data.segs.segs_label(yy,xx));
0425     <span class="keyword">end</span>
0426     
0427     
0428     regs_label_mod = (bwlabel( cell_mask_mod, 4 ));
0429     tmp2_props = regionprops( regs_label_mod, <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span>,<span class="string">'Centroid'</span>,<span class="string">'Area'</span>);
0430     num_regs_mod = max(regs_label_mod(:));
0431     
0432     info = zeros(num_regs_mod, CONST.regionScoreFun.NUM_INFO);
0433     
0434     ss_regs_label_mod = size( regs_label_mod );
0435     <span class="comment">%disp(['num regs: ', num2str(num_regs_mod)] );</span>
0436     <span class="keyword">for</span> mm = 1:num_regs_mod;
0437         
0438         
0439         [xx_,yy_] = getBBpad( tmp2_props(mm).BoundingBox, ss_regs_label_mod, 1);
0440         
0441         <span class="keyword">try</span>
0442             mask = regs_label_mod(yy_,xx_)==mm;
0443         <span class="keyword">catch</span>
0444             <span class="string">''</span>;
0445         <span class="keyword">end</span>
0446         
0447         <span class="keyword">try</span>
0448             info(mm,:) = CONST.regionScoreFun.props( mask, tmp2_props(mm)  );
0449         <span class="keyword">catch</span>
0450             disp(<span class="string">'Big error!'</span>);
0451         <span class="keyword">end</span>
0452         
0453         <span class="keyword">if</span> debug_flag
0454             disp([<span class="string">'reg '</span>, num2str(mm), <span class="string">' sc '</span>, num2str(CONST.regionScoreFun.fun(info(mm,:),CONST.regionScoreFun.E))]);
0455             <span class="comment">% [info,CONST.regionScoreFun.fun(info)]</span>
0456         <span class="keyword">end</span>
0457     <span class="keyword">end</span>
0458     
0459     
0460     regionScore(jj) = sum(-CONST.regionScoreFun.fun(info,CONST.regionScoreFun.E))+<span class="keyword">...</span>
0461         sum((1-2*vect).*<a href="#_sub11" class="code" title="subfunction ee = FixE( ee )">FixE</a>(data.segs.scoreRaw(segs_list)'))*CONST.regionOpti.DE_norm;
0462     
0463     
0464     <span class="keyword">if</span> debug_flag
0465         clf;
0466         imshow( cat(3,autogain(cell_mask)*.25+autogain(cell_mask_mod)*.25,<span class="keyword">...</span>
0467             autogain(cell_mask)*.25+autogain(cell_mask_mod)*.25,<span class="keyword">...</span>
0468             autogain(cell_mask)*.25+autogain(cell_mask_mod)*.25),<span class="string">'InitialMagnification'</span>,<span class="string">'fit'</span>);
0469         
0470         
0471         regionScore(jj)
0472         
0473         
0474     <span class="keyword">end</span>
0475     
0476 <span class="keyword">end</span>
0477 
0478 [min_score, jj_min] = min(regionScore);
0479 <span class="comment">%min_score</span>
0480 vect = <a href="#_sub1" class="code" title="subfunction vect = makeVector( nn, n )">makeVector</a>(jj_min-1,num_segs);
0481 
0482 <span class="comment">%         if dispp</span>
0483 <span class="comment">%         clf;</span>
0484 <span class="comment">%         imshow( cat(3,autogain(mask_regs)*.25+autogain(regs_label==ii)*.25,...</span>
0485 <span class="comment">%             autogain(mask_regs)*.25+autogain(mask_regs==ii)*.25,...</span>
0486 <span class="comment">%             autogain(mask_regs)*.25+autogain(mask_regs==ii)*.25));</span>
0487 <span class="comment">%</span>
0488 <span class="comment">% %        'hi'</span>
0489 <span class="comment">%         end</span>
0490 <span class="keyword">end</span>
0491 
0492 
0493 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0494 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0495 <span class="comment">%%</span>
0496 <span class="comment">%% simAnneal: Find the minimum energy configuration by a simulated</span>
0497 <span class="comment">%%            anneal procedure.</span>
0498 <span class="comment">%%</span>
0499 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0500 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0501 <a name="_sub3" href="#_subfunctions" class="code">function vect = simAnnealFast( segs_list, data, cell_mask, xx, yy, CONST, debug_flag)</a>
0502 
0503 <span class="keyword">if</span> ~exist(<span class="string">'debug_flag'</span>, <span class="string">'var'</span>) || isempty( debug_flag )
0504     debug_flag = 0;
0505 <span class="keyword">end</span>
0506 
0507 ss = size(data.phase);
0508 num_segs = numel(segs_list);
0509 
0510 
0511 <span class="keyword">if</span> isfield( CONST.regionOpti, <span class="string">'ADJUST_FLAG'</span> ) &amp;&amp; CONST.regionOpti.ADJUST_FLAG
0512     Nt = floor(CONST.regionOpti.Nt * num_segs/10);
0513 <span class="keyword">else</span>
0514     Nt = CONST.regionOpti.Nt;
0515 <span class="keyword">end</span>
0516 
0517 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0518 <span class="comment">% state vector contains all the info about the current state</span>
0519 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0520 state = [];
0521 
0522 <span class="comment">% turn on the segs that are predicted to be on based on the seg scores</span>
0523 <span class="comment">% computed by superSeggerOpti.</span>
0524 vect = data.segs.scoreRaw(segs_list)&gt;0;
0525 
0526 E = <a href="#_sub4" class="code" title="subfunction E = initState( vect0 )">initState</a>( vect );
0527 
0528 recMap = containers.Map( <a href="#_sub7" class="code" title="subfunction str = makeKey( vect )">makeKey</a>( vect ), E );
0529 
0530 <span class="keyword">if</span> debug_flag
0531     EHist = zeros(1,Nt);
0532     tttt = 1:Nt;
0533     stateMat = zeros(num_segs,Nt);
0534 <span class="keyword">end</span>
0535 
0536 <span class="comment">%debugFig</span>
0537 <span class="comment">%'hi'</span>
0538 <span class="comment">%tic</span>
0539 <span class="keyword">for</span> t = 1:Nt;
0540     
0541     T = <a href="#_sub10" class="code" title="subfunction    T = tempSchedule(t, CONST, num_segs)">tempSchedule</a>(t,CONST,num_segs);
0542     
0543     E0 = E;
0544     
0545     <span class="comment">% perturb configuration</span>
0546     nn = floor(rand*num_segs)+1;
0547     vect_tmp = state.seg_vect0;
0548     vect_tmp(nn) = ~vect_tmp(nn);
0549     
0550     key = <a href="#_sub7" class="code" title="subfunction str = makeKey( vect )">makeKey</a>(vect_tmp);
0551     <span class="keyword">if</span> isKey(recMap, key)
0552         keyFlag = 1;
0553         E = recMap(key);
0554     <span class="keyword">else</span>
0555         keyFlag = 0;
0556         E = <a href="#_sub5" class="code" title="subfunction E = perturbState( nn )">perturbState</a>(nn);
0557         recMap(key) = E;
0558     <span class="keyword">end</span>
0559     
0560     DE = E0-E;
0561     
0562     <span class="keyword">if</span> rand &gt; exp( DE/T )
0563         <span class="comment">% Throw away perturbed state</span>
0564         E = E0;
0565     <span class="keyword">else</span>
0566         <span class="comment">% Fix pertrubed state</span>
0567         <span class="keyword">if</span> keyFlag
0568             <a href="#_sub5" class="code" title="subfunction E = perturbState( nn )">perturbState</a>(nn);
0569         <span class="keyword">end</span>
0570         <a href="#_sub8" class="code" title="subfunction fixState( )">fixState</a>();
0571     <span class="keyword">end</span>
0572     
0573     <span class="keyword">if</span> debug_flag
0574         EHist(t) = E;
0575         stateMat(:,t) = state.seg_vect0;
0576     <span class="keyword">end</span>
0577     <span class="comment">%     %%%%%%%%%%% debug %%%%%%%%%%%%%%</span>
0578     <span class="comment">% clf;</span>
0579     <span class="comment">% plot(accept_vect,'.-');</span>
0580     <span class="comment">%</span>
0581     <span class="comment">% 'hi';</span>
0582     <span class="comment">%</span>
0583     <span class="comment">%</span>
0584     <span class="comment">%         cell_mask_mod = 0*cell_mask;</span>
0585     <span class="comment">%         for kk = 1:num_segs</span>
0586     <span class="comment">%             cell_mask_mod = cell_mask_mod + vect(kk)*(segs_list(kk)==data.segs.segs_label(yy,xx));</span>
0587     <span class="comment">%         end</span>
0588     <span class="comment">%</span>
0589     <span class="comment">%          clf;</span>
0590     <span class="comment">%          imshow( cat(3,autogain(cell_mask)*.25+autogain(cell_mask_mod)*0.25,...</span>
0591     <span class="comment">%              autogain(cell_mask)*.25+autogain(cell_mask_mod_)*0.25,...</span>
0592     <span class="comment">%              autogain(cell_mask)*.25+autogain(cell_mask_mod)*0),'InitialMagnification','fit');</span>
0593     <span class="comment">%</span>
0594     <span class="comment">%</span>
0595     <span class="comment">%          'hi'</span>
0596     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0597     
0598 <span class="keyword">end</span>
0599 <span class="comment">%toc</span>
0600 <span class="comment">%debugFig</span>
0601 <span class="comment">%'hi'</span>
0602 
0603 vect = double(state.seg_vect0');
0604 
0605 
0606 <span class="keyword">if</span> debug_flag
0607     [minEHist,ppp] = min(EHist(end:-1:1));
0608     ppp = numel(EHist)-ppp+1;
0609     minEHist
0610     
0611     figure(CONST.regionOpti.fignum);
0612     clf;
0613     subplot(2,1,1);
0614     imagesc( stateMat );
0615     
0616     subplot(2,1,2);
0617     semilogy(tttt,EHist-minEHist+1,<span class="string">'r.-'</span>);
0618     hold on;
0619     semilogy(tttt(ppp),1,<span class="string">'go'</span>);
0620 <span class="keyword">end</span>
0621 
0622 
0623 
0624     <a name="_sub4" href="#_subfunctions" class="code">function E = initState( vect0 )</a>
0625         
0626         state.seg_E = <a href="#_sub11" class="code" title="subfunction ee = FixE( ee )">FixE</a>(data.segs.scoreRaw(segs_list))*CONST.regionOpti.DE_norm;
0627         state.seg_vect0 = logical(vect0);
0628         state.seg_mask= cell (1, num_segs  );
0629         state.mask_out= cell (1, num_segs  );
0630         state.seg_vect1= logical(vect0);
0631         state.reg_E= zeros(1, num_segs+3);
0632         state.reg_vect0= false(1, num_segs+3);
0633         state.reg_mask= cell (1, num_segs+3);
0634         state.reg_label= [];
0635         state.reg_props= [];
0636         state.reg_vect1= false(1, num_segs+3);
0637         state.mask= [];
0638         state.ss= 0;
0639         
0640         <span class="comment">% make the new modified mask based on the seg state vector</span>
0641         state.mask = cell_mask;
0642         
0643         <span class="keyword">for</span> kk = 1:num_segs
0644             state.seg_mask{kk} = (segs_list(kk)==data.segs.segs_label(yy,xx));
0645             state.mask_out{kk} = bwmorph( state.seg_mask{kk}, <span class="string">'dilate'</span> );
0646             <span class="keyword">if</span> vect0(kk)
0647                 state.mask(state.seg_mask{kk}) = false;
0648             <span class="keyword">end</span>
0649         <span class="keyword">end</span>
0650         
0651         <span class="comment">% label the regs</span>
0652         state.reg_label = bwlabel( state.mask, 8 );
0653         state.reg_props  = regionprops( state.reg_label, <span class="keyword">...</span>
0654             <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span>,<span class="string">'Area'</span>);
0655         
0656         num_regs_mod   = max(state.reg_label(:));
0657         
0658         state.ss = size(state.reg_label);
0659         
0660         <span class="comment">% loop through the regs</span>
0661         kk_range = 1:num_regs_mod;
0662         state.reg_vect0(kk_range) = 1;
0663         state.reg_vect1 = state.reg_vect0;
0664         <span class="keyword">for</span> kk = kk_range;
0665             [xx_,yy_] = getBBpad( state.reg_props(kk).BoundingBox, state.ss, 0);
0666             state.reg_mask{kk} = (state.reg_label==kk);
0667             info = CONST.regionScoreFun.props( state.reg_mask{kk}(yy_,xx_), state.reg_props(kk)  );
0668             state.reg_E(kk) = CONST.regionScoreFun.fun(info,CONST.regionScoreFun.E);
0669         <span class="keyword">end</span>
0670         <span class="keyword">for</span> kk = (num_regs_mod+1):(num_segs+3)
0671             state.reg_mask{kk} = false(state.ss);
0672         <span class="keyword">end</span>
0673         
0674         E = <a href="#_sub9" class="code" title="subfunction E = calcE(reg_vect,seg_vect,state)">calcE</a>(state.reg_vect0, state.seg_vect0, state);
0675         
0676         
0677         <span class="comment">%debugFig;</span>
0678         <span class="comment">%'hi'</span>
0679     <span class="keyword">end</span>
0680 
0681     <a name="_sub5" href="#_subfunctions" class="code">function E = perturbState( nn )</a>
0682         
0683         state.seg_vect1 = state.seg_vect0;
0684         state.reg_vect1 = state.reg_vect0;
0685         
0686         <span class="comment">% if the boundary chosen is on, figure out which regions</span>
0687         <span class="comment">% are neighboring.</span>
0688         <span class="keyword">if</span> state.seg_vect0(nn)
0689             <span class="comment">%disp( ['Turn off seg ',num2str(nn)] );</span>
0690             state.seg_vect1(nn) = false;
0691             ind0 = unique(state.reg_label(state.mask_out{nn}))';
0692             ind0 = ind0(logical(ind0));
0693             state.reg_vect1(ind0) = false;
0694             
0695             ind1 = find( ~state.reg_vect0, 1, <span class="string">'first'</span> );
0696             state.reg_vect1(ind1) =  true;
0697             <span class="keyword">try</span>
0698                 state.reg_mask{ind1} = state.seg_mask{nn};
0699             <span class="keyword">catch</span>
0700                 <span class="string">'hi'</span>
0701             <span class="keyword">end</span>
0702             <span class="keyword">for</span> kk = ind0
0703                 state.reg_mask{ind1} = <span class="keyword">...</span>
0704                     or(state.reg_mask{ind1}, state.reg_mask{kk});
0705             <span class="keyword">end</span>
0706             reg_props_tmp = regionprops( double(state.reg_mask{ind1}), <span class="keyword">...</span>
0707                 <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span>,<span class="string">'Area'</span>);
0708             
0709             [xx_,yy_] = getBBpad( reg_props_tmp.BoundingBox, state.ss, 0);
0710             
0711             info = CONST.regionScoreFun.props( state.reg_mask{ind1}(yy_,xx_), reg_props_tmp(1)  );
0712             state.reg_E(ind1) = <span class="keyword">...</span>
0713                 CONST.regionScoreFun.fun(info,CONST.regionScoreFun.E);
0714             
0715             <span class="comment">%disp( 'Remove reg: ');</span>
0716             <span class="comment">%ind0</span>
0717             
0718             <span class="comment">%disp( 'Add reg: ');</span>
0719             <span class="comment">%ind1</span>
0720             
0721             
0722             <span class="comment">% if the boundary is off, pick out the region that will</span>
0723             <span class="comment">% be split</span>
0724             
0725         <span class="keyword">else</span>
0726             <span class="comment">%disp( ['Turn on seg ',num2str(nn)] );</span>
0727             
0728             state.seg_vect1(nn) = true;
0729             ind0 = unique(state.reg_label(state.seg_mask{nn}));
0730             
0731             <span class="comment">%disp( 'Remove region:' );</span>
0732             <span class="comment">%ind0</span>
0733             
0734             mask_tmp = xor( state.seg_mask{nn}, state.reg_mask{ind0(1)});
0735             
0736             reg_label_tmp = bwlabel( mask_tmp, 8 );
0737             reg_props_tmp = regionprops( reg_label_tmp, <span class="keyword">...</span>
0738                 <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span>,<span class="string">'Area'</span>);
0739             
0740             ind_tmp = unique(reg_label_tmp( mask_tmp ))';
0741             ind_tmp = ind_tmp(logical(ind_tmp));
0742             ind1 = [];
0743             <span class="keyword">for</span> kk = ind_tmp
0744                 ind1 = [ind1, find( ~state.reg_vect1, 1, <span class="string">'first'</span> )];
0745                 state.reg_mask{ind1(end)} = (reg_label_tmp==kk);
0746                 state.reg_vect1(ind1(end)) = true;
0747                 state.reg_props(ind1(end)) = reg_props_tmp(kk);
0748                 
0749                 [xx_,yy_] = getBBpad( reg_props_tmp(kk).BoundingBox, state.ss, 0);
0750                 
0751                 info = CONST.regionScoreFun.props( state.reg_mask{ind1(end)}(yy_,xx_), reg_props_tmp(kk)  );
0752                 state.reg_E(ind1(end)) = <span class="keyword">...</span>
0753                     CONST.regionScoreFun.fun(info,CONST.regionScoreFun.E);
0754             <span class="keyword">end</span>
0755             state.reg_vect1(ind0) = false;
0756             
0757             <span class="comment">%disp('Add region: ');</span>
0758             <span class="comment">%ind1</span>
0759         <span class="keyword">end</span>
0760         
0761         E = <a href="#_sub9" class="code" title="subfunction E = calcE(reg_vect,seg_vect,state)">calcE</a>(state.reg_vect1, state.seg_vect1, state);
0762         
0763         <span class="comment">%debugFig;</span>
0764         <span class="comment">%'hi'</span>
0765         
0766     <span class="keyword">end</span>
0767 
0768     <a name="_sub6" href="#_subfunctions" class="code">function debugFig</a>
0769         
0770         L = zeros(state.ss);
0771         SegGood0 = L;
0772         SegBad0  = L;
0773         SegGood1 = L;
0774         SegBad1  = L;
0775         RegOnOn  = L;
0776         RegOnOff = L;
0777         RegOffOn = L;
0778         
0779         Lreg = L;
0780         
0781         <span class="keyword">for</span> kk = 1:num_segs
0782             L(state.seg_mask{kk}) = kk;
0783             <span class="keyword">if</span> state.seg_vect0(kk)
0784                 SegGood0(state.seg_mask{kk}) = 1;
0785             <span class="keyword">else</span>
0786                 SegBad0(state.seg_mask{kk}) = 1;
0787             <span class="keyword">end</span>
0788             <span class="keyword">if</span> state.seg_vect1(kk)
0789                 SegGood1(state.seg_mask{kk}) = 1;
0790             <span class="keyword">else</span>
0791                 SegBad1(state.seg_mask{kk}) = 1;
0792             <span class="keyword">end</span>
0793         <span class="keyword">end</span>
0794         
0795         <span class="keyword">for</span> kk = 1:num_segs+3
0796             <span class="keyword">if</span> state.reg_vect0(kk);
0797                 Lreg(state.reg_mask{kk}) = kk;
0798             <span class="keyword">end</span>
0799             
0800             <span class="keyword">if</span> state.reg_vect0(kk) &amp;&amp; ~state.reg_vect1(kk)
0801                 RegOnOff(state.reg_mask{kk}) = <span class="keyword">...</span>
0802                     RegOnOff(state.reg_mask{kk}) + 1;
0803             <span class="keyword">end</span>
0804             
0805             <span class="keyword">if</span> ~state.reg_vect0(kk) &amp;&amp; state.reg_vect1(kk)
0806                 RegOffOn(state.reg_mask{kk}) = <span class="keyword">...</span>
0807                     RegOffOn(state.reg_mask{kk}) + 1;
0808             <span class="keyword">end</span>
0809             
0810             <span class="keyword">if</span> state.reg_vect0(kk) &amp;&amp; state.reg_vect1(kk)
0811                 RegOnOn(state.reg_mask{kk}) = <span class="keyword">...</span>
0812                     RegOnOn(state.reg_mask{kk}) + 1;
0813             <span class="keyword">end</span>
0814             
0815         <span class="keyword">end</span>
0816         
0817         seg_props = regionprops( L, <span class="string">'Centroid'</span> );
0818         reg_props = regionprops( Lreg, <span class="string">'Centroid'</span> );
0819         
0820         
0821         
0822         figure(1);
0823         clf;
0824         
0825         backer = 0.2*ag(data.phase(yy,xx));
0826         
0827         imshow( cat(3,backer+0.3*ag(SegGood0),backer+0.15*ag(logical(Lreg)),<span class="keyword">...</span>
0828             backer+0.3*ag(SegBad0)),<span class="string">'InitialMagnification'</span>,<span class="string">'fit'</span>);
0829         hold on;
0830         
0831         
0832         
0833         <span class="keyword">for</span> kk = 1:num_segs
0834             
0835             cc = double(and(state.seg_vect0(kk),state.seg_vect1(kk)))*[1 1 1] + <span class="keyword">...</span>
0836                 double(and(~state.seg_vect0(kk),state.seg_vect1(kk)))*[0 0 1] + <span class="keyword">...</span>
0837                 double(and(state.seg_vect0(kk),~state.seg_vect1(kk)))*[1 0 0];
0838             
0839             text( seg_props(kk).Centroid(1), seg_props(kk).Centroid(2), <span class="keyword">...</span>
0840                 num2str(kk), <span class="string">'Color'</span>, cc );
0841         <span class="keyword">end</span>
0842         
0843         
0844         <span class="keyword">for</span> kk = 1:num_segs+3
0845             
0846             cc = [0 1 0];
0847             <span class="keyword">if</span> state.reg_vect0(kk);
0848                 text( reg_props(kk).Centroid(1), reg_props(kk).Centroid(2), <span class="keyword">...</span>
0849                     num2str(kk), <span class="string">'Color'</span>, cc );
0850             <span class="keyword">end</span>
0851             
0852             
0853         <span class="keyword">end</span>
0854         
0855         figure(2);
0856         clf;
0857         imshow( cat(3,backer+0.3*ag(RegOffOn),backer+0.3*ag(RegOnOn),<span class="keyword">...</span>
0858             backer+0.3*ag(RegOnOff)),<span class="string">'InitialMagnification'</span>,<span class="string">'fit'</span>);
0859         hold on;
0860         
0861         <span class="keyword">for</span> kk = 1:num_segs
0862             
0863             cc = double(and(state.seg_vect0(kk),state.seg_vect1(kk)))*[1 1 1] + <span class="keyword">...</span>
0864                 double(and(~state.seg_vect0(kk),state.seg_vect1(kk)))*[0 0 1] + <span class="keyword">...</span>
0865                 double(and(state.seg_vect0(kk),~state.seg_vect1(kk)))*[1 0 0];
0866             
0867             text( seg_props(kk).Centroid(1), seg_props(kk).Centroid(2), <span class="keyword">...</span>
0868                 num2str(kk), <span class="string">'Color'</span>, cc );
0869         <span class="keyword">end</span>
0870         
0871         
0872         <span class="keyword">for</span> kk = 1:num_segs+3
0873             
0874             cc = [0 1 0];
0875             <span class="keyword">if</span> state.reg_vect0(kk);
0876                 text( reg_props(kk).Centroid(1), reg_props(kk).Centroid(2), <span class="keyword">...</span>
0877                     num2str(kk), <span class="string">'Color'</span>, cc );
0878             <span class="keyword">end</span>
0879             
0880             
0881         <span class="keyword">end</span>
0882         
0883         figure(3);
0884         clf;
0885         
0886         imshow( state.reg_label, [], <span class="string">'InitialMagnification'</span>,<span class="string">'fit'</span>);
0887         colormap hot;
0888         
0889     <span class="keyword">end</span>
0890 
0891 
0892 
0893 
0894     <a name="_sub7" href="#_subfunctions" class="code">function str = makeKey( vect )</a>
0895         str = char(double(vect)'+<span class="string">'a'</span>);
0896     <span class="keyword">end</span>
0897 <span class="comment">% this function fixes the perturbed state as the current state.</span>
0898     <a name="_sub8" href="#_subfunctions" class="code">function fixState( )</a>
0899         <span class="comment">%disp( 'Fix Region' );</span>
0900         
0901         <span class="comment">%disp( 'Deleting: ');</span>
0902         ind_del = find(and(state.reg_vect0,~state.reg_vect1));
0903         <span class="keyword">for</span> kk = ind_del
0904             state.reg_label(state.reg_mask{kk}) = 0;
0905             state.mask(state.reg_mask{kk})      = false;
0906         <span class="keyword">end</span>
0907         
0908         <span class="comment">%disp( 'Adding: ');</span>
0909         ind_add = find(and(state.reg_vect1,~state.reg_vect0));
0910         <span class="keyword">for</span> kk = ind_add
0911             state.reg_label(state.reg_mask{kk}) = kk;
0912             state.mask(state.reg_mask{kk})      = true;
0913         <span class="keyword">end</span>
0914         
0915         state.reg_vect0 = state.reg_vect1;
0916         state.seg_vect0 = state.seg_vect1;
0917         
0918         <span class="comment">%debugFig();</span>
0919         <span class="comment">%'hi'</span>
0920     <span class="keyword">end</span>
0921 <span class="keyword">end</span>
0922 
0923 
0924 
0925 
0926 
0927 
0928 
0929 
0930 <a name="_sub9" href="#_subfunctions" class="code">function E = calcE(reg_vect,seg_vect,state)</a>
0931 E = sum(-state.reg_E(reg_vect))+sum((1-2*double(seg_vect)).*state.seg_E);
0932 <span class="keyword">end</span>
0933 
0934 
0935 <a name="_sub10" href="#_subfunctions" class="code">function    T = tempSchedule(t, CONST, num_segs)</a>
0936 
0937 <span class="comment">%Emax = 1e3;</span>
0938 <span class="comment">%dt = 10;</span>
0939 
0940 <span class="keyword">if</span> isfield( CONST.regionOpti, <span class="string">'ADJUST_FLAG'</span> ) &amp;&amp; CONST.regionOpti.ADJUST_FLAG
0941     dt   = CONST.regionOpti.dt*10/num_segs;
0942 <span class="keyword">else</span>
0943     dt   = CONST.regionOpti.dt;
0944 <span class="keyword">end</span>
0945 
0946 Emax = CONST.regionOpti.Emax;
0947 
0948 T = Emax*exp(-t/dt);
0949 <span class="keyword">end</span>
0950 
0951 <a name="_sub11" href="#_subfunctions" class="code">function ee = FixE( ee )</a>
0952 <span class="comment">%global CutOffScoreHi;</span>
0953 <span class="comment">%global CutOffScoreLo;</span>
0954 
0955 
0956 <span class="comment">%cutH = 5*CutOffScoreHi;</span>
0957 <span class="comment">%cutL = 5*CutOffScoreLo;</span>
0958 
0959 <span class="comment">%ee = ee.*(ee&lt;=cutH).*(ee&gt;=cutL) + cutH.*(ee&gt;cutH) + cutL.*(ee&lt;cutL);</span>
0960 
0961 <span class="keyword">end</span>
0962 
0963 
0964 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0965 <span class="comment">%</span>
0966 <span class="comment">% Old sim anneal function</span>
0967 <span class="comment">%</span>
0968 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0969 <a name="_sub12" href="#_subfunctions" class="code">function vect = simAnneal( segs_list, data, cell_mask, xx, yy, CONST, debug_flag)</a>
0970 
0971 <span class="keyword">if</span> ~exist(<span class="string">'debug_flag'</span>, <span class="string">'var'</span>) || isempty( debug_flag )
0972     debug_flag = 0;
0973 <span class="keyword">end</span>
0974 
0975 
0976 ss = size(data.phase);
0977 
0978 num_segs = numel(segs_list);
0979 
0980 
0981 Nt = CONST.regionOpti.Nt;
0982 
0983 
0984 
0985 vect = double(data.segs.scoreRaw(segs_list)&gt;0);
0986 E  = <a href="#_sub13" class="code" title="subfunction E = doE(justDoIt, CONST)">doE</a>(1,CONST);
0987 
0988 <span class="keyword">try</span>
0989     recMap = containers.Map( char(vect'+<span class="string">'a'</span>), E );
0990 <span class="keyword">catch</span>
0991     <span class="string">'hi'</span>
0992 <span class="keyword">end</span>
0993 
0994 
0995 <span class="comment">% %%%%%%%%%%% debug %%%%%%%%%%%%%%</span>
0996 <span class="comment">%         cell_mask_mod_ = 0*cell_mask;</span>
0997 <span class="comment">%         for kk = 1:num_segs</span>
0998 <span class="comment">%             cell_mask_mod_ = cell_mask_mod_ + (segs_list(kk)==data.segs.segs_label(yy,xx));</span>
0999 <span class="comment">%         end</span>
1000 <span class="comment">%</span>
1001 <span class="comment">%          clf;</span>
1002 <span class="comment">%          imshow( cat(3,autogain(cell_mask)*.25+autogain(cell_mask_mod_)*0.25,...</span>
1003 <span class="comment">%              autogain(cell_mask)*.25+autogain(data.segs.segs_label(yy,xx)&gt;0)*0.25,...</span>
1004 <span class="comment">%              autogain(cell_mask)*.25+autogain(cell_mask_mod_)*0),'InitialMagnification','fit');</span>
1005 <span class="comment">%</span>
1006 <span class="comment">%          'hi'</span>
1007 <span class="comment">%</span>
1008 <span class="comment">%          accept_vect = zeros(1,Nt);</span>
1009 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1010 
1011 <span class="keyword">if</span> debug_flag
1012     EEEE = zeros(1,Nt);
1013     tttt = 1:Nt;
1014     stateMat = zeros(num_segs,Nt);
1015     
1016 <span class="keyword">end</span>
1017 
1018 <span class="keyword">for</span> t = 1:Nt;
1019     
1020     T = <a href="#_sub10" class="code" title="subfunction    T = tempSchedule(t, CONST, num_segs)">tempSchedule</a>(t,CONST);
1021     
1022     <span class="comment">% copy in old configuration</span>
1023     vect0 = vect;
1024     E0    = E;
1025     <span class="comment">% perturb configuration</span>
1026     nn = floor(rand*num_segs)+1;
1027     vect(nn) = ~vect(nn);
1028     E = <a href="#_sub13" class="code" title="subfunction E = doE(justDoIt, CONST)">doE</a>(0,CONST);
1029     
1030     
1031     DE = E0-E;
1032     
1033     <span class="keyword">if</span> rand &gt; exp( DE/T )
1034         vect = vect0;
1035         E = E0;
1036         <span class="comment">%accept_vect(t) = 0;</span>
1037     <span class="keyword">else</span>
1038         <span class="comment">%accept_vect(t) = 1;</span>
1039     <span class="keyword">end</span>
1040     
1041     <span class="keyword">if</span> debug_flag
1042         EEEE(t) = E;
1043         stateMat(:,t) = vect;
1044     <span class="keyword">end</span>
1045     <span class="comment">%     %%%%%%%%%%% debug %%%%%%%%%%%%%%</span>
1046     <span class="comment">% clf;</span>
1047     <span class="comment">% plot(accept_vect,'.-');</span>
1048     <span class="comment">%</span>
1049     <span class="comment">% 'hi';</span>
1050     <span class="comment">%</span>
1051     <span class="comment">%</span>
1052     <span class="comment">%         cell_mask_mod = 0*cell_mask;</span>
1053     <span class="comment">%         for kk = 1:num_segs</span>
1054     <span class="comment">%             cell_mask_mod = cell_mask_mod + vect(kk)*(segs_list(kk)==data.segs.segs_label(yy,xx));</span>
1055     <span class="comment">%         end</span>
1056     <span class="comment">%</span>
1057     <span class="comment">%          clf;</span>
1058     <span class="comment">%          imshow( cat(3,autogain(cell_mask)*.25+autogain(cell_mask_mod)*0.25,...</span>
1059     <span class="comment">%              autogain(cell_mask)*.25+autogain(cell_mask_mod_)*0.25,...</span>
1060     <span class="comment">%              autogain(cell_mask)*.25+autogain(cell_mask_mod)*0),'InitialMagnification','fit');</span>
1061     <span class="comment">%</span>
1062     <span class="comment">%</span>
1063     <span class="comment">%          'hi'</span>
1064     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1065     
1066 <span class="keyword">end</span>
1067 
1068 <span class="keyword">if</span> debug_flag
1069     [minEEEE,ppp] = min(EEEE(end:-1:1));
1070     ppp = numel(EEEE)-ppp+1;
1071     minEEEE
1072     
1073     figure(CONST.regionOpti.fignum);
1074     clf;
1075     subplot(2,1,1);
1076     imagesc( stateMat );
1077     
1078     subplot(2,1,2);
1079     semilogy(tttt,EEEE-minEEEE+1,<span class="string">'r.-'</span>);
1080     hold on;
1081     semilogy(tttt(ppp),1,<span class="string">'go'</span>);
1082 <span class="keyword">end</span>
1083 
1084 
1085     <a name="_sub13" href="#_subfunctions" class="code">function E = doE(justDoIt, CONST)</a>
1086         
1087         <span class="keyword">if</span> ~justDoIt &amp;&amp; isKey( recMap, char(vect'+<span class="string">'a'</span>) )
1088             
1089             E = recMap( char(vect'+<span class="string">'a'</span>) );
1090         <span class="keyword">else</span>
1091             DE_norm = CONST.regionOpti.DE_norm;
1092             
1093             
1094             cell_mask_mod = cell_mask;
1095             
1096             <span class="keyword">for</span> kk = 1:num_segs
1097                 cell_mask_mod = cell_mask_mod - vect(kk)*(segs_list(kk)==data.segs.segs_label(yy,xx));
1098             <span class="keyword">end</span>
1099             
1100             regs_label_mod = (bwlabel( cell_mask_mod, 8 ));
1101             props_tmp = regionprops( regs_label_mod, <span class="string">'BoundingBox'</span>,<span class="string">'Orientation'</span>,<span class="string">'Area'</span>);
1102             num_regs_mod = max(regs_label_mod(:));
1103             
1104             info = zeros(num_regs_mod, CONST.regionScoreFun.NUM_INFO);
1105             
1106             
1107             ss_regs_label_mod = size(regs_label_mod);
1108             
1109             <span class="keyword">for</span> mm = 1:num_regs_mod;
1110                 
1111                 [xx_,yy_] = getBBpad( props_tmp(mm).BoundingBox, ss_regs_label_mod, 1);
1112                 mask = regs_label_mod(yy_,xx_)==mm;
1113                 
1114                 
1115                 info(mm,:) = CONST.regionScoreFun.props( mask, props_tmp(mm)  );
1116             <span class="keyword">end</span>
1117             
1118             E = sum(-CONST.regionScoreFun.fun(info,CONST.regionScoreFun.E))+sum((1-2*vect).*<a href="#_sub11" class="code" title="subfunction ee = FixE( ee )">FixE</a>(data.segs.scoreRaw(segs_list)))*DE_norm;
1119             
1120             <span class="keyword">if</span> ~justDoIt
1121                 recMap(char(vect'+<span class="string">'a'</span>)) = E;
1122             <span class="keyword">end</span>
1123         <span class="keyword">end</span>
1124     <span class="keyword">end</span>
1125 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 23-Feb-2016 16:32:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>