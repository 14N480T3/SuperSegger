<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of cellprops0</title>
  <meta name="keywords" content="cellprops0">
  <meta name="description" content="cellprops0 Calculates the shape properties of the region or 'cell'">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">SuperSeggerRelease</a> &gt; <a href="index.html">segmentation</a> &gt; cellprops0.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for SuperSeggerRelease/segmentation&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>cellprops0
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>cellprops0 Calculates the shape properties of the region or 'cell'</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function info = cellprops0( mask, props ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> cellprops0 Calculates the shape properties of the region or 'cell'

 INPUT :
       mask : cell / region mask
       props : proper generated by regionprops
 OUTPUT :
         info = [L1
             L2mean,
             Lneck,
             L2max,
             L2v,
             s1,
             s2,
             s3,
             RoundIndOver,
             RoundIndUnder,
             props.Area,
             stm1,
             sa1,
             sa2,
             sa3,
             sa4,
             1/L1,
             1/L2mean,
             minWidthEnd,
             sqmin,
             sqmax];

 Copyright (C) 2016 Wiggins Lab
 University of Washington, 2016
 This file is part of SuperSeggerOpti.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function tmp = norm2( dd )</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function info = cellprops0( mask, props )</a>
0002 <span class="comment">% cellprops0 Calculates the shape properties of the region or 'cell'</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% INPUT :</span>
0005 <span class="comment">%       mask : cell / region mask</span>
0006 <span class="comment">%       props : proper generated by regionprops</span>
0007 <span class="comment">% OUTPUT :</span>
0008 <span class="comment">%         info = [L1</span>
0009 <span class="comment">%             L2mean,</span>
0010 <span class="comment">%             Lneck,</span>
0011 <span class="comment">%             L2max,</span>
0012 <span class="comment">%             L2v,</span>
0013 <span class="comment">%             s1,</span>
0014 <span class="comment">%             s2,</span>
0015 <span class="comment">%             s3,</span>
0016 <span class="comment">%             RoundIndOver,</span>
0017 <span class="comment">%             RoundIndUnder,</span>
0018 <span class="comment">%             props.Area,</span>
0019 <span class="comment">%             stm1,</span>
0020 <span class="comment">%             sa1,</span>
0021 <span class="comment">%             sa2,</span>
0022 <span class="comment">%             sa3,</span>
0023 <span class="comment">%             sa4,</span>
0024 <span class="comment">%             1/L1,</span>
0025 <span class="comment">%             1/L2mean,</span>
0026 <span class="comment">%             minWidthEnd,</span>
0027 <span class="comment">%             sqmin,</span>
0028 <span class="comment">%             sqmax];</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% Copyright (C) 2016 Wiggins Lab</span>
0031 <span class="comment">% University of Washington, 2016</span>
0032 <span class="comment">% This file is part of SuperSeggerOpti.</span>
0033 
0034 
0035 debug = false;
0036 
0037 
0038 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0039 <span class="comment">%</span>
0040 <span class="comment">% Calculate cell thickness and length by rotating the</span>
0041 <span class="comment">% region based on the angle of the majorAxis.</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0044 Orientation = props.Orientation;
0045 
0046 imRot = (fast_rotate_loose_double( mask, -Orientation+90 ));
0047 ss = size(imRot);
0048 
0049 
0050 <span class="keyword">if</span> debug
0051     figure(2);
0052     clf;
0053     imshow(cat(3,ag(imRot)+0.5*ag(~imRot),ag(imRot),ag(imRot)),<span class="string">'InitialMagnification'</span>,<span class="string">'fit'</span>);
0054     hold on;
0055 <span class="keyword">end</span>
0056 
0057 width       = sum(double(imRot),2);
0058 ymask       = (width&gt;=1);
0059 widthWindow = ([0;width(1:end-1)] + width + [width(2:end);0] )/3;
0060 
0061 L1          = sum(ymask);
0062 L2max       = max(widthWindow);
0063 
0064 
0065 ymin = find(ymask,1,<span class="string">'first'</span>);
0066 ymax = find(ymask,1,<span class="string">'last'</span>);
0067 
0068 L2mean = mean(width((ymin):(ymax)));
0069 
0070 
0071 
0072 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0073 <span class="comment">%</span>
0074 <span class="comment">% Calculate the neck width</span>
0075 <span class="comment">%</span>
0076 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0077 <span class="keyword">if</span> numel(widthWindow) &gt; 6;
0078     ww       = widthWindow';
0079     v        = ww(3:end)-ww(1:end-2);
0080     s_change = logical([0, sign(v(2:end))-sign(v(1:end-1)),0,0]);
0081     s_change(2:end) = logical(s_change(2:end)+s_change(1:end-1));
0082     
0083     ind = find(s_change);
0084     ind_ = ind(logical((ind&gt;3).*(ind&lt;(numel(ww)-2))));
0085     
0086     
0087     <span class="keyword">if</span> isempty(ind_)
0088         Lneck = L2mean;
0089         pos = mean([ymin,ymax]);
0090     <span class="keyword">else</span>
0091         [Lneck,pos] = min( ww(ind_) );
0092         pos = ind_(pos);
0093     <span class="keyword">end</span>
0094 <span class="keyword">else</span>
0095     Lneck = L2mean;
0096     pos = mean([ymin,ymax]);
0097 <span class="keyword">end</span>
0098 
0099 <span class="keyword">if</span> Lneck &gt; L2mean
0100     Lneck = L2mean;
0101     pos = mean([ymin,ymax]);
0102 <span class="keyword">end</span>
0103 
0104 <span class="keyword">if</span> debug
0105     xx = 1:numel(ww);
0106     
0107     figure(1);
0108     clf;
0109     plot( xx, ww, <span class="string">'.-'</span> );
0110     hold on;
0111     plot( pos+0*x,x, <span class="string">'r:'</span> );
0112     plot( xx(ind_), ww(ind_), <span class="string">'g.'</span> );
0113     figure(2)
0114 <span class="keyword">end</span>
0115 
0116 
0117 
0118 
0119 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0120 <span class="comment">%</span>
0121 <span class="comment">% Calculate the maximum bend angle.</span>
0122 <span class="comment">%</span>
0123 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0124 dr  = 5;
0125 dr2 = 3;
0126 yy = (ymin+dr):dr2:(ymax-dr);
0127 
0128 <span class="keyword">if</span> numel(yy) &gt; 4
0129     tmp = imRot(yy,:);
0130     
0131     x = 1:ss(2);
0132     
0133     
0134     [X,Y] = meshgrid(x,yy);
0135     
0136     xx = sum( X.*tmp,2 )./sum(tmp,2);
0137     
0138     d1 = [xx(1:end-2)-xx(3:end),yy(1:end-2)'-yy(3:end)'];
0139     
0140     stm = abs((d1(1:end-2,1).*d1(3:<span class="keyword">end</span>,2)<span class="keyword">...</span>
0141         -d1(1:end-2,2).*d1(3:<span class="keyword">end</span>,1))./<span class="keyword">...</span>
0142         (<a href="#_sub1" class="code" title="subfunction tmp = norm2( dd )">norm2</a>(d1(1:end-2,:)).*<a href="#_sub1" class="code" title="subfunction tmp = norm2( dd )">norm2</a>(d1(3:<span class="keyword">end</span>,:))));
0143     
0144     
0145     stm = max( stm );
0146     
0147     <span class="keyword">if</span> debug
0148         
0149         ss_ = size(d1);
0150         
0151         <span class="keyword">for</span> ii = 1:ss_(1)
0152             
0153             plot( xx(ii)+[0,-d1(ii,1)], yy(ii)+[0,-d1(ii,2)], <span class="string">'c.'</span> );
0154         <span class="keyword">end</span>
0155     <span class="keyword">end</span>
0156     
0157     
0158     
0159     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0160     <span class="comment">%</span>
0161     <span class="comment">% Calculate the end score</span>
0162     <span class="comment">%</span>
0163     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0164     yy = [(ymin+dr),(ymax-dr)];
0165     xx = widthWindow(round(yy));
0166     r = ((xx)/2);
0167     
0168     
0169     yyd = [(ymin+r(1)+[-1,0,1]),(ymax-r(2)+[-1,0,1])];
0170     yy  = round(yyd);
0171     
0172     [X] = meshgrid(x,yy);
0173     tmp = imRot(yy,:);
0174     xx = sum( X.*tmp,2 )./sum(tmp,2);
0175     xx = [mean(xx(1:3)),mean(xx(4:6))];
0176     yyd = yyd([2,5]);
0177     
0178     <span class="keyword">if</span> debug
0179         phi = 0:.1:2*pi;
0180         
0181         plot(xx,yyd,<span class="string">'go'</span>);
0182         xxx = r(1)*cos(phi);
0183         yyy = r(1)*sin(phi);
0184         plot(xx(1)+xxx,yy(1)+yyy,<span class="string">'g:'</span>)
0185         
0186         xxx = r(2)*cos(phi);
0187         yyy = r(2)*sin(phi);
0188         plot(xx(2)+xxx,yyd(2)+yyy,<span class="string">'g:'</span>)
0189         
0190         plot( [1,ss(2)],[ymax,ymax],<span class="string">':r'</span>)
0191         plot( [1,ss(2)],[ymin,ymin],<span class="string">':r'</span>)
0192         
0193     <span class="keyword">end</span>
0194     
0195     xcen = xx;
0196     ycen = yyd;
0197     
0198     x0 = xcen(1);
0199     y0 = ycen(1);
0200     r0 = r(1);
0201     
0202     yy = max(1,round(y0-r0-2)):min(round(y0+r0+2),ss(1));
0203     xx = max(1,round(x0-r0-2)):min(round(x0+r0+2),ss(2));
0204     
0205     [X,Y] = meshgrid(xx,yy);
0206     tmp = imRot(yy,xx);
0207     
0208     R2 = (X-x0).^2 + (Y-y0).^2 - r0^2;
0209     
0210     ind_over = find( ((R2 &gt; 0).*tmp).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &gt; 0));
0211     ind_under = find( ((R2 &lt; 0).*(tmp&lt;1)).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &gt; 0));
0212     
0213     
0214     <span class="keyword">if</span> debug
0215         plot(X(ind_over),Y(ind_over),<span class="string">'r.'</span>);
0216         plot(X(ind_under),Y(ind_under),<span class="string">'b.'</span>);
0217     <span class="keyword">end</span>
0218     
0219     RoundIndOverTop  = sum( tmp(ind_over).*R2(ind_over))/r0^4;
0220     RoundIndUnderTop = sum( (1-tmp(ind_under)).*abs(R2(ind_under)))/r0^4;
0221     
0222     x0 = xcen(2);
0223     y0 = ycen(2);
0224     r0 = r(2);
0225     
0226     yy = max(1,round(y0-r0-2)):min(round(y0+r0+2),ss(1));
0227     xx = max(1,round(x0-r0-2)):min(round(x0+r0+2),ss(2));
0228     
0229     [X,Y] = meshgrid(xx,yy);
0230     tmp = imRot(yy,xx);
0231     
0232     R2 = (X-x0).^2 + (Y-y0).^2 - r0^2;
0233     
0234     ind_over = find( ((R2 &gt; 0).*tmp).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &lt; 0));
0235     ind_under = find( ((R2 &lt; 0).*(tmp&lt;1)).*(d1(1,1)*(X-x0) + d1(1,2)*(Y-y0) &lt; 0));
0236     
0237     <span class="keyword">if</span> debug
0238         plot(X(ind_over),Y(ind_over),<span class="string">'r.'</span>);
0239         plot(X(ind_under),Y(ind_under),<span class="string">'b.'</span>);
0240     <span class="keyword">end</span>
0241     
0242     
0243     RoundIndOverBot  = sum( tmp(ind_over).*R2(ind_over))/r0^4;
0244     RoundIndUnderBot = sum( (1-tmp(ind_under)).*abs(R2(ind_under)))/r0^4;
0245     
0246 <span class="keyword">else</span>
0247     <span class="comment">%'fail'</span>
0248     stm = 0;
0249     RoundIndOverTop  = 0;
0250     RoundIndUnderTop = 0;
0251     RoundIndOverBot  = 0;
0252     RoundIndUnderBot = 0;
0253     
0254 <span class="keyword">end</span>
0255 
0256 
0257 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0258 
0259 RoundIndOver  = RoundIndOverTop  + RoundIndOverBot;
0260 RoundIndUnder = RoundIndUnderTop + RoundIndUnderBot;
0261 
0262 
0263 
0264 
0265 <span class="comment">%info = [L1,L2,Lneck,curve];</span>
0266 info = [L1,L2max,Lneck,L2mean, stm, RoundIndOver, RoundIndUnder, props.Area];
0267 info(isnan(info)) = 0;
0268 
0269 
0270 
0271 <span class="keyword">if</span> debug
0272     drawnow;
0273     keyboard;
0274 <span class="keyword">end</span>
0275 
0276 
0277 
0278 <span class="keyword">end</span>
0279 
0280 <a name="_sub1" href="#_subfunctions" class="code">function tmp = norm2( dd )</a>
0281 
0282 tmp = sqrt(sum(dd.*dd,2));
0283 
0284 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 23-Feb-2016 16:32:17 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>